{"version":3,"file":"index.js","sources":["../../../../../../packages/extension/WhichWay/src/modules/index.js"],"sourcesContent":["import { lib, game, ui, get, ai, _status } from \"noname\";\r\nimport { whichWayFile } from \"../file.js\";\r\nimport { onContent, onSetDev } from \"../hooks/index.js\";\r\nimport { whichWayUtil } from \"../utill.js\";\r\nimport { modules, modulesList } from \"./data.js\";\r\n\r\nconst modulesSet = window.whichWaySave.modulesSet;\r\n\r\nclass WhichWayCharacterModules {\r\n\tmodules = {};\r\n\r\n\tmodulesList = [];\r\n\r\n\tasync init() {\r\n\t\t//初始化模组\r\n\t\tthis.modules = {\r\n\t\t\t...modules,\r\n\t\t};\r\n\t\tthis.modulesList.push(...modulesList);\r\n\r\n        onContent({\r\n            name:\"whichWayCharacterModules_init\",\r\n            fn:()=>{\r\n                this.initCharModules();\r\n            }\r\n        })\r\n\t}\r\n\r\n\t/**\r\n\t * 获取指定角色的所有可用模组或当前装备的模组。\r\n\t *\r\n\t * 如果 `current` 为 true，则返回该角色当前激活的模组（若存在），否则返回默认模组。\r\n\t * 如果 `current` 为 false，则返回该角色在 `modulesList` 中定义的所有模组；\r\n\t * 若该角色未定义任何模组，则返回一个默认的基础模组。\r\n\t *\r\n\t * @param {string | Player} name - 角色名或者模组名\r\n\t * @param {boolean} [current=true] - 是否只获取当前激活的模组（仅name为角色名时有效）。\r\n\t * @returns {Object} 返回一个表示模组或模组集合的对象。\r\n\t *\r\n\t * @example\r\n\t * // 获取当前激活模组\r\n\t * const currentModule = getCharModules('character1');\r\n\t *\r\n\t * // 获取所有可用模组\r\n\t * const allModules = getCharModules('character1', false);\r\n\t */\r\n\tgetCharModules(name, current = true) {\r\n\t\tif (get.itemtype(name) === \"player\") {\r\n            //@ts-ignore\r\n\t\t\tname = get.name(name);\r\n\t\t}\r\n\t\tconst defaultModule = {\r\n\t\t\tdefault: {\r\n\t\t\t\turl: whichWayFile.compilePath(\"mod:default.png\"),\r\n\t\t\t\tname: `基础证章`,\r\n\t\t\t\tid: \"default\",\r\n\t\t\t\tintro: [\"基础证章，无特殊效果。\", `${get.translation(name)}通过罗德岛人事部考核，准许参加外勤任务`, \"特别颁发此证章\", \"以兹证明\"],\r\n\t\t\t},\r\n\t\t};\r\n        //@ts-ignore\r\n\t\tif (window.whichWaySave.allCharacters.includes(name) && this.modulesList.includes(name)) {\r\n\t\t\tthrow new Error(`${name} 即是角色名也是模组名，请重新命名模组！`);\r\n\t\t}\r\n\r\n\t\tif (name === \"default\") return defaultModule.default;\r\n        //@ts-ignore\r\n\t\tif (window.whichWaySave.allCharacters.includes(name)) {\r\n\t\t\tif (current) {\r\n                //@ts-ignore\r\n\t\t\t\tif (!modulesSet[name]) return defaultModule.default;\r\n                //@ts-ignore\r\n\t\t\t\treturn this.getCharModules(modulesSet[name]);\r\n\t\t\t}\r\n            //@ts-ignore\r\n\t\t\tif (!Object.keys(this.modules).includes(name)) return defaultModule;\r\n\t\t\tlet copyCharModules = {\r\n\t\t\t\tdefault: defaultModule.default,\r\n\t\t\t\t...this.modules[name],\r\n\t\t\t};\r\n\t\t\tfor (let key in copyCharModules) {\r\n\t\t\t\tlet info = copyCharModules[key];\r\n\t\t\t\tif (!info.url) info.url = whichWayFile.compilePath(`mod:${name}/${key}.png`);\r\n\t\t\t\tif (!info.id) info.id = key;\r\n\t\t\t}\r\n\t\t\treturn copyCharModules;\r\n\t\t} else if (this.modulesList.includes(name)) {\r\n\t\t\tfor (let key in this.modules) {\r\n\t\t\t\tlet info = this.modules[key];\r\n\t\t\t\t/** @ts-ignore */\r\n\t\t\t\tif (Object.keys(info).includes(name)) {\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\turl: whichWayFile.compilePath(`mod:${key}/${name}.png`),\r\n\t\t\t\t\t\tid: name,\r\n\t\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\t\t...info[name],\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (whichWayUtil.isDeveloperMode()) console.warn(`角色或模组 ${name} 不存在`);\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * 设置角色的模组\r\n\t *\r\n\t * 如果尚未存在全局配置对象 `lib.config.sjzxModuleSet`，则会自动创建。\r\n\t * 如果未提供 `moduleName`，则默认使用 \"default\" 模组。\r\n\t * 如果指定的角色或模组不存在，则会抛出错误。\r\n\t *\r\n\t * @param {string} name - 角色名称，用于标识要设置模组的角色。\r\n\t * @param {string} [moduleName] - 要设置的模组名称，默认为 \"default\"。\r\n\t * @returns {string} 模组名。\r\n\t */\r\n\tsetCharModules(name, moduleName) {\r\n\t\tif (!moduleName) moduleName = \"default\";\r\n\t\tlet modules = this.getCharModules(name, false);\r\n\t\tif (!modules[moduleName]) throw new Error(`设置失败：${name} 的模组 ${moduleName} 不存在`);\r\n\t\tmodulesSet[name] = moduleName;\r\n\t\twhichWayUtil.saveConfig(\"modulesSet\", modulesSet);\r\n\t\tthis.initCharModules();\r\n\t\treturn moduleName;\r\n\t}\r\n\r\n\tinitCharModules() {\r\n\t\t/** @ts-ignore */\r\n\t\tif (_status.gameStarted) {\r\n\t\t\tgame.players.forEach(char => {\r\n\t\t\t\tlet modulesChars = Object.keys(modulesSet);\r\n\t\t\t\tif (modulesChars.includes(char.name)) {\r\n\t\t\t\t\tlet module = this.getCharModules(char);\r\n\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\tif (!lib.character[char.name].copySJZX)\r\n\t\t\t\t\t\t//@ts-ignore\r\n\t\t\t\t\t\tlib.character[char.name].copySJZX = {\r\n\t\t\t\t\t\t\t...lib.character[char.name],\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\tif (module.id === \"default\") {\r\n\t\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\t\tlet { skills: originalSkills } = lib.character[char.name].copySJZX;\r\n\t\t\t\t\t\tif (lib.character[char.name].skills !== originalSkills) {\r\n\t\t\t\t\t\t\tchar.removeSkill(lib.character[char.name].skills);\r\n\t\t\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\t\t\tchar.addSkill(originalSkills);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\t\tlib.character[char.name] = lib.character[char.name].copySJZX;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (module.effect) {\r\n\t\t\t\t\t\tlet effect = module.effect;\r\n\t\t\t\t\t\tif (effect.content) effect.content(char, lib.character[char.name]);\r\n\t\t\t\t\t\tif (effect.changeSkill) {\r\n\t\t\t\t\t\t\tlet changeSkill = Array.isArray(effect.changeSkill) ? effect.changeSkill : [effect.changeSkill];\r\n\t\t\t\t\t\t\tchar.removeSkill(char.getOriginalSkills());\r\n\t\t\t\t\t\t\t/** @ts-ignore */\r\n\t\t\t\t\t\t\tchar.addSkill(changeSkill);\r\n\t\t\t\t\t\t\tlib.character[char.name].skills = changeSkill;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.clearCharModuleDefaultSet();\r\n\t\t\tfor (let name in modulesSet) {\r\n\t\t\t\tlet moduleName = modulesSet[name];\r\n\t\t\t\tlet module = this.getCharModules(moduleName);\r\n\t\t\t\tlet playerObj = lib.character[name];\r\n\t\t\t\tif (module.effect) {\r\n\t\t\t\t\tlet effect = module.effect;\r\n\t\t\t\t\tif (effect.content) effect.content(undefined, playerObj);\r\n\t\t\t\t\tif (effect.changeSkill) {\r\n\t\t\t\t\t\tlet changeSkill = Array.isArray(effect.changeSkill) ? effect.changeSkill : [effect.changeSkill];\r\n\t\t\t\t\t\tlib.character[name].skills = changeSkill;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tclearCharModuleDefaultSet() {\r\n\t\tfor (let charName in modulesSet) {\r\n\t\t\tif (modulesSet[charName] === \"default\") delete modulesSet[charName];\r\n\t\t}\r\n\t\twhichWayUtil.saveConfig(\"modulesSet\", modulesSet);\r\n\t\treturn modulesSet;\r\n\t}\r\n}\r\n\r\nexport const whichWayCharacterModules = new WhichWayCharacterModules();\r\n\r\nawait whichWayCharacterModules.init();\r\n\r\nonSetDev({\r\n\tname: \"whichWayCharacterModules_setDev\",\r\n\tfn: () => {\r\n\t\t//@ts-ignore\r\n\t\twindow.whichWayCharacterModules = whichWayCharacterModules;\r\n\t},\r\n});\r\n\r\nwindow.whichWay.register(\"characterModules\", whichWayCharacterModules);\r\n"],"names":["modules"],"mappings":"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"}