{"version":3,"file":"index.js","sources":["../../../../../../packages/extension/WhichWay/src/hooks/index.js"],"sourcesContent":["class WhichWayHooks {\r\n\tconstructor() {\r\n\t\tthis._generateHooks();\r\n\t\tthis._autoId = 0;\r\n\t\tthis._hookContexts = {};\r\n\t}\r\n\r\n\t/**\r\n\t * 等待注册的钩子,注册后会自动拓展Before和After\r\n\t * @type {string[]}\r\n\t */\r\n\t_pendingHooks = [\"extension\", \"arenaReady\", \"prepare\", \"precontent\", \"content\", \"config\", \"init\", \"character\", \"setDev\"];\r\n\r\n\t_hooks = {\r\n\t\tconfig: [],\r\n\t};\r\n\r\n\t/**\r\n\t * 自动生成钩子数组和 onXxx / onBeforeXxx / onAfterXxx 方法\r\n\t */\r\n\t_generateHooks() {\r\n\t\tfor (const name of this._pendingHooks) {\r\n\t\t\tconst capName = name.charAt(0).toUpperCase() + name.slice(1);\r\n\r\n\t\t\t// 初始化钩子队列（避免重复）\r\n\t\t\tif (!(name in this._hooks)) {\r\n\t\t\t\tthis._hooks[name] = [];\r\n\t\t\t\tthis._hooks[`before${capName}`] = [];\r\n\t\t\t\tthis._hooks[`after${capName}`] = [];\r\n\t\t\t}\r\n\r\n\t\t\t// 自动生成 onXxx 方法（绑定 this）\r\n\t\t\tconst createOnMethod = hookKey => {\r\n\t\t\t\treturn fnOrObj => this._registerHook(hookKey, fnOrObj);\r\n\t\t\t};\r\n\r\n\t\t\t// 定义 onXxx, onBeforeXxx, onAfterXxx\r\n\t\t\tthis[`on${capName}`] = createOnMethod(name);\r\n\t\t\tthis[`onBefore${capName}`] = createOnMethod(`before${capName}`);\r\n\t\t\tthis[`onAfter${capName}`] = createOnMethod(`after${capName}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 为某个 hook 阶段注册默认上下文参数\r\n\t * @param {string} hookName - 如 \"init\", \"character\"\r\n\t * @param {any[]} args - 要传入的参数数组\r\n\t */\r\n\t_registerHookContext(hookName, ...args) {\r\n\t\tconst capName = hookName.charAt(0).toUpperCase() + hookName.slice(1);\r\n\t\tthis._hookContexts[`before${capName}`] = args;\r\n\t\tthis._hookContexts[`after${capName}`] = args;\r\n\t\tthis._hookContexts[hookName] = args;\r\n\t}\r\n\r\n\t/**\r\n\t * 为 hook 阶段在指定位置设置参数（从 0 开始）\r\n\t * @param {string} hookName\r\n\t * @param {number} index\r\n\t * @param {*} value\r\n\t */\r\n\t_registerHookContextAt(hookName, index, value) {\r\n\t\tconst capName = hookName.charAt(0).toUpperCase() + hookName.slice(1);\r\n\t\tif (!this._hookContexts[hookName]) {\r\n\t\t\tthis._hookContexts[hookName] = [];\r\n\t\t\tthis._hookContexts[`before${capName}`] = [];\r\n\t\t\tthis._hookContexts[`after${capName}`] = [];\r\n\t\t}\r\n\t\tthis._hookContexts[hookName][index] = value;\r\n\t\tthis._hookContexts[`before${capName}`][index] = value;\r\n\t\tthis._hookContexts[`after${capName}`][index] = value;\r\n\t}\r\n\r\n\t_registerHook(hookKey, fn) {\r\n\t\tif (typeof fn === \"function\") {\r\n\t\t\tfn = { fn };\r\n\t\t} else if (typeof fn === \"object\" && fn.fn === undefined && typeof fn.obj === \"object\") {\r\n\t\t\t//后续处理,此处留空\r\n\t\t\t//检查下fn.obj.name是否存在,作为config,必须要有name\r\n\t\t\tif (fn.obj.name === undefined) throw new Error(`[WhichWayHooks] Invalid config hook return object, missing \"name\" property: ${fn.obj}`);\r\n\t\t} else if (typeof fn !== \"object\" || fn.fn === undefined) {\r\n\t\t\tthrow new Error(\"[WhichWayHooks] Invalid hook registration object\");\r\n\t\t}\r\n\r\n\t\tlet { name: givenName, priority = 0, fn: hookFn, obj: hookObj } = fn;\r\n\t\tconst name = givenName || `anonymous_${++this._autoId}`;\r\n\r\n\t\tconst existing = this._hooks[hookKey].find(h => h.name === name);\r\n\t\tif (existing) {\r\n\t\t\tthrow new Error(`[WhichWayHooks] Duplicate hook name \"${name}\" in \"${hookKey}\". ` + `Hook names must be unique within the same lifecycle stage.`);\r\n\t\t}\r\n\r\n\t\tif (hookFn === void 0 && hookObj !== void 0) {\r\n\t\t\thookFn = () => hookObj;\r\n\t\t}\r\n\r\n\t\tthis._hooks[hookKey].push({ name, fn: hookFn, priority, obj: hookObj });\r\n\t}\r\n\r\n\tonConfig(fnOrObj) {\r\n\t\tthis._registerHook(\"config\", fnOrObj);\r\n\t}\r\n\r\n\tasync _runHooks(name, overrideArgs) {\r\n\t\tconst hooks = this._hooks[name];\r\n\t\tif (!hooks?.length) return;\r\n\r\n\t\t// 优先使用传入的 overrideArgs，否则用注册的上下文\r\n\t\tconst args = overrideArgs !== void 0 ? overrideArgs : this._hookContexts[name] || [];\r\n\r\n\t\tconst sorted = [...hooks].sort((a, b) => b.priority - a.priority);\r\n\t\tfor (const { name: hookName, fn } of sorted) {\r\n\t\t\ttry {\r\n\t\t\t\tawait fn(...args);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(`[WhichWayHooks] Error in hook \"${hookName}\" (${name}):`, err);\r\n\t\t\t\tthrow err;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 运行生命周期阶段的钩子\r\n\t * @param {string} name - 生命周期阶段名称,如 \"init\", \"content\"\r\n\t * @param {any[]} [overrideArgs] - 要传入的额外参数数组,如 content(config, pack)\r\n\t */\r\n\tasync _runLifecycle(name, overrideArgs) {\r\n\t\tconst capName = name.charAt(0).toUpperCase() + name.slice(1);\r\n\t\tawait this._runHooks(`before${capName}`, overrideArgs);\r\n\t\tawait this._runHooks(name, overrideArgs);\r\n\t\tawait this._runHooks(`after${capName}`, overrideArgs);\r\n\t}\r\n\r\n\t_mergeConfig() {\r\n\t\tconst hooks = this._hooks.config;\r\n\t\tif (!hooks.length) return {};\r\n\r\n\t\tconst sorted = [...hooks].sort((a, b) => b.priority - a.priority);\r\n\r\n\t\tlet merged = {};\r\n\t\tfor (const { name: hookName, fn, obj: hookObj } of sorted) {\r\n\t\t\ttry {\r\n\t\t\t\tconst part = typeof fn === \"function\" ? fn() : {};\r\n\r\n\t\t\t\tconst { name, options } = part;\r\n\r\n\t\t\t\tconst option = {};\r\n\r\n\t\t\t\tif ([name, options].some(v => v === void 0)) throw new Error(`[WhichWayHooks] Invalid config hook return object: ${part}`);\r\n\r\n\t\t\t\tif (hookObj !== void 0) options[\"obj\"] = hookObj;\r\n\r\n\t\t\t\toption[name] = options;\r\n\r\n\t\t\t\tmerged = { ...merged, ...option };\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(`[WhichWayHooks] Error in config hook \"${hookName}\":`, err);\r\n\t\t\t\tthrow err;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn merged;\r\n\t}\r\n\r\n\tget whichWayHooksApi() {\r\n\t\tconst self = this;\r\n\t\treturn {\r\n\t\t\tarenaReady: async () => await self._runLifecycle(\"arenaReady\"),\r\n\t\t\tprepare: async () => await self._runLifecycle(\"prepare\"),\r\n\t\t\tprecontent: async () => await self._runLifecycle(\"precontent\"),\r\n\t\t\tcontent: async (config, pack) => await self._runLifecycle(\"content\", [config, pack]),\r\n\t\t\textension: async () => await self._runLifecycle(\"extension\"),\r\n\t\t\tget config() {\r\n\t\t\t\treturn self._mergeConfig();\r\n\t\t\t},\r\n\r\n\t\t\tsetDev: async () => await self._runLifecycle(\"setDev\"),\r\n\t\t\tcharacter: async pack => await self._runLifecycle(\"character\", [pack]),\r\n\t\t\tinit: async () => await self._runLifecycle(\"init\"),\r\n\t\t};\r\n\t}\r\n}\r\n\r\nconst whichWayHooks = new WhichWayHooks();\r\n\r\n/**\r\n * @type {WhichWayExportHooks}\r\n */\r\n//@ts-ignore\r\nconst exportsMethods = {\r\n\t//这玩意不是方法,需要手动添加\r\n\twhichWayHooksApi: whichWayHooks.whichWayHooksApi,\r\n\tregisterHookContext: whichWayHooks._registerHookContext.bind(whichWayHooks),\r\n\tregisterHookContextAt: whichWayHooks._registerHookContextAt.bind(whichWayHooks),\r\n};\r\n\r\n//对方法进行绑定,所有的方法必须以\"on\"开头,否则检测不到!\r\nfor (const key of Object.keys(whichWayHooks)) {\r\n\tif (key.startsWith(\"on\") && typeof whichWayHooks[key] === \"function\") {\r\n\t\texportsMethods[key] = whichWayHooks[key].bind(whichWayHooks);\r\n\t}\r\n}\r\n\r\nexport const { onSetDev, onExtension, onBeforeExtension, onAfterExtension, onArenaReady, onBeforeArenaReady, onAfterArenaReady, onPrepare, onBeforePrepare, onAfterPrepare, onPrecontent, onBeforePrecontent, onAfterPrecontent, onContent, onBeforeContent, onAfterContent, onConfig, onCharacter, onAfterCharacter,onBeforeCharacter,onInit,onAfterInit, onBeforeInit, whichWayHooksApi, registerHookContext,registerHookContextAt } = exportsMethods;\r\n\r\n// 开发者模式暴露\r\nonSetDev({\r\n\tname: \"whichWayHooks_dev\",\r\n\tfn: () => {\r\n\t\twindow.whichWayHooks = whichWayHooks;\r\n\t},\r\n\tpriority: 114514,\r\n});\r\n\r\n//由于hooks加载顺序问题,需要推迟再注册到全局对象\r\nonExtension({\r\n\tname: \"whichWayHooks_register\",\r\n\tfn: () => {\r\n\t\twindow.whichWay.register(\"hooks\", whichWayHooks);\r\n\t},\r\n});\r\n"],"names":[],"mappings":"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"}