{"version":3,"file":"version.js","sources":["../../../../../packages/extension/WhichWay/src/version.js"],"sourcesContent":["import { lib, game, ui, get, ai, _status } from \"noname\";\r\nimport { whichWayUtil } from \"./utill.js\";\r\nimport { onExtension, onSetDev } from \"./hooks/index.js\";\r\n\r\nconst whichWayVersionInfo = {\r\n\tnoname: {\r\n        //最佳版本\r\n\t\tnew: \"1.11.1\",\r\n        //最低版本\r\n\t\tover: \"1.11.0\",\r\n\t},\r\n\text: \"1.1.2\",\r\n};\r\n\r\nclass WhichWayVersion {\r\n\tget lastCheckedExtVersion() {\r\n\t\treturn whichWayUtil.config(\"lastCheckedExtVersion\") || \"\";\r\n\t}\r\n\r\n\tget lastCheckedNonameVersion() {\r\n\t\treturn whichWayUtil.config(\"lastCheckedNonameVersion\") || \"\";\r\n\t}\r\n\r\n\tget noname() {\r\n\t\treturn whichWayVersionInfo.noname;\r\n\t}\r\n\tget ext() {\r\n\t\treturn whichWayVersionInfo.ext;\r\n\t}\r\n\r\n\t/**\r\n\t * 扩展版本是否发生变化\r\n\t */\r\n\textVersionChanged = false;\r\n\r\n\t/**\r\n\t * 本体版本是否发生变化\r\n\t */\r\n\tnonameVersionChanged = false;\r\n\r\n\t/**\r\n\t * 检查版本兼容性：\r\n\t * - 仅当（当前扩展版本, 当前无名杀版本）与上次检查的组合不同时，才执行检查\r\n\t * - 兼容则静默通过；不兼容则弹窗，之后仍记录该组合为“已检查”\r\n\t */\r\n\tcheckVersionCompatible() {\r\n\t\tconst extUnchanged = this.checkVersion(this.ext, this.lastCheckedExtVersion) === 0;\r\n\t\tconst nonameUnchanged = this.checkVersion(lib.version, this.lastCheckedNonameVersion) === 0;\r\n\t\tif (extUnchanged && nonameUnchanged) {\r\n\t\t\treturn;\r\n\t\t} else {\r\n\t\t\tthis.extVersionChanged =!extUnchanged;\r\n\t\t\tthis.nonameVersionChanged =!nonameUnchanged;\r\n\t\t}\r\n\r\n\t\tconst consqOver = this.checkVersion(lib.version, this.noname.over);\r\n\t\tconst consqNew = this.checkVersion(lib.version, this.noname.new);\r\n\r\n\t\tthis._saveLastCheckedVersions();\r\n\r\n\t\tif (consqOver < 0) {\r\n\t\t\tconst close = confirm(\r\n\t\t\t\t`⚠️ 【驶舰之向】当前无名杀版本 (${lib.version}) 低于最低要求 (${this.noname.over})！\\n` +\r\n\t\t\t\t`可能导致严重错误或崩溃。\\n` +\r\n\t\t\t\t`推荐升级至 ${this.noname.new}。\\n` +\r\n\t\t\t\t`点击“确定”将立即禁用本扩展。`\r\n\t\t\t);\r\n\t\t\tif (close) {\r\n\t\t\t\twhichWayUtil.disableExtension();\r\n\t\t\t}\r\n\t\t} else if (consqNew !== 0) {\r\n\t\t\tconst close = confirm(\r\n\t\t\t\t`ℹ️ 【驶舰之向】当前无名杀版本 (${lib.version}) 与推荐版本 (${this.noname.new}) 不一致。\\n` +\r\n\t\t\t\t`部分新功能可能受限或表现异常。\\n` +\r\n\t\t\t\t`点击“确定”可禁用本扩展。`\r\n\t\t\t);\r\n\t\t\tif (close) {\r\n\t\t\t\twhichWayUtil.disableExtension();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 保存当前版本组合为“已检查”\r\n\t * @private\r\n\t */\r\n\t_saveLastCheckedVersions() {\r\n\t\twhichWayUtil.saveConfig(\"lastCheckedExtVersion\", this.ext);\r\n\t\twhichWayUtil.saveConfig(\"lastCheckedNonameVersion\", lib.version);\r\n\t}\r\n\r\n\t/**\r\n\t * 版本比较：v1 vs v2\r\n\t * @param {string} v1\r\n\t * @param {string} v2\r\n\t * @returns {number} -1: v1 < v2, 0: v1 == v2, 1: v1 > v2\r\n\t */\r\n\tcheckVersion(v1, v2) {\r\n\t\tif (!v1 || !v2) return v1 === v2 ? 0 : v1 ? 1 : -1;\r\n\t\tconst a = v1.split(\".\").map(Number);\r\n\t\tconst b = v2.split(\".\").map(Number);\r\n\t\tconst len = Math.max(a.length, b.length);\r\n\t\tfor (let i = 0; i < len; i++) {\r\n\t\t\tconst x = a[i] || 0;\r\n\t\t\tconst y = b[i] || 0;\r\n\t\t\tif (x < y) return -1;\r\n\t\t\tif (x > y) return 1;\r\n\t\t}\r\n\t\treturn 0;\r\n\t}\r\n}\r\n\r\nexport const whichWayVersion = new WhichWayVersion();\r\n\r\n// 开发者模式暴露\r\nonSetDev({\r\n\tname: \"whichWayVersion_dev\",\r\n\tfn: () => {\r\n\t\t//@ts-ignore\r\n\t\twindow.whichWayVersion = whichWayVersion;\r\n\t},\r\n\tpriority: 0,\r\n});\r\n\r\n//由于version加载顺序问题,需要推迟再注册到全局对象\r\nonExtension({\r\n\tname:\"whichWayVersion_register\",\r\n\tfn:()=>{\r\n\t\twindow.whichWay.register(\"version\", whichWayVersion);\r\n\t}\r\n})"],"names":[],"mappings":";;;AAIA,MAAM,sBAAsB;AAAA,EAC3B,QAAQ;AAAA;AAAA,IAEP,KAAK;AAAA;AAAA,IAEL,MAAM;AAAA,EACR;AAAA,EACC,KAAK;AACN;AAEA,MAAM,gBAAgB;AAAA,EACrB,IAAI,wBAAwB;AAC3B,WAAO,aAAa,OAAO,uBAAuB,KAAK;AAAA,EACxD;AAAA,EAEA,IAAI,2BAA2B;AAC9B,WAAO,aAAa,OAAO,0BAA0B,KAAK;AAAA,EAC3D;AAAA,EAEA,IAAI,SAAS;AACZ,WAAO,oBAAoB;AAAA,EAC5B;AAAA,EACA,IAAI,MAAM;AACT,WAAO,oBAAoB;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,oBAAoB;AAAA;AAAA;AAAA;AAAA,EAKpB,uBAAuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOvB,yBAAyB;AACxB,UAAM,eAAe,KAAK,aAAa,KAAK,KAAK,KAAK,qBAAqB,MAAM;AACjF,UAAM,kBAAkB,KAAK,aAAa,IAAI,SAAS,KAAK,wBAAwB,MAAM;AAC1F,QAAI,gBAAgB,iBAAiB;AACpC;AAAA,IACD,OAAO;AACN,WAAK,oBAAmB,CAAC;AACzB,WAAK,uBAAsB,CAAC;AAAA,IAC7B;AAEA,UAAM,YAAY,KAAK,aAAa,IAAI,SAAS,KAAK,OAAO,IAAI;AACjE,UAAM,WAAW,KAAK,aAAa,IAAI,SAAS,KAAK,OAAO,GAAG;AAE/D,SAAK,yBAAwB;AAE7B,QAAI,YAAY,GAAG;AAClB,YAAM,QAAQ;AAAA,QACb,qBAAqB,IAAI,OAAO,aAAa,KAAK,OAAO,IAAI;AAAA;AAAA,QAEpD,KAAK,OAAO,GAAG;AAAA;AAAA,MAE5B;AACG,UAAI,OAAO;AACV,qBAAa,iBAAgB;AAAA,MAC9B;AAAA,IACD,WAAW,aAAa,GAAG;AAC1B,YAAM,QAAQ;AAAA,QACb,qBAAqB,IAAI,OAAO,YAAY,KAAK,OAAO,GAAG;AAAA;AAAA;AAAA,MAG/D;AACG,UAAI,OAAO;AACV,qBAAa,iBAAgB;AAAA,MAC9B;AAAA,IACD;AAAA,EACD;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,2BAA2B;AAC1B,iBAAa,WAAW,yBAAyB,KAAK,GAAG;AACzD,iBAAa,WAAW,4BAA4B,IAAI,OAAO;AAAA,EAChE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,aAAa,IAAI,IAAI;AACpB,QAAI,CAAC,MAAM,CAAC,GAAI,QAAO,OAAO,KAAK,IAAI,KAAK,IAAI;AAChD,UAAM,IAAI,GAAG,MAAM,GAAG,EAAE,IAAI,MAAM;AAClC,UAAM,IAAI,GAAG,MAAM,GAAG,EAAE,IAAI,MAAM;AAClC,UAAM,MAAM,KAAK,IAAI,EAAE,QAAQ,EAAE,MAAM;AACvC,aAAS,IAAI,GAAG,IAAI,KAAK,KAAK;AAC7B,YAAM,IAAI,EAAE,CAAC,KAAK;AAClB,YAAM,IAAI,EAAE,CAAC,KAAK;AAClB,UAAI,IAAI,EAAG,QAAO;AAClB,UAAI,IAAI,EAAG,QAAO;AAAA,IACnB;AACA,WAAO;AAAA,EACR;AACD;AAEY,MAAC,kBAAkB,IAAI,gBAAe;AAGlD,SAAS;AAAA,EACR,MAAM;AAAA,EACN,IAAI,MAAM;AAET,WAAO,kBAAkB;AAAA,EAC1B;AAAA,EACA,UAAU;AACX,CAAC;AAGD,YAAY;AAAA,EACX,MAAK;AAAA,EACL,IAAG,MAAI;AACN,WAAO,SAAS,SAAS,WAAW,eAAe;AAAA,EACpD;AACD,CAAC;"}