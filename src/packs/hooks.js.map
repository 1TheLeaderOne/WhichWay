{"version":3,"file":"hooks.js","sources":["../../../../../../packages/extension/WhichWay/src/packs/hooks.ts"],"sourcesContent":["import { lib, game, ui, get, ai, _status } from \"noname\";\r\n\r\nclass WhichWayPackHooks {\r\n\tconstructor() {\r\n\t\tthis._generateHooks();\r\n\t}\r\n\r\n\tprivate _autoId = 0;\r\n\r\n\t// ===== 钩子分组定义 =====\r\n\tprivate _stringHooks = [\"translate\", \"characterIntro\", \"characterTitle\"]; // string: string\r\n\tprivate _arrayHooks = [\"characterReplace\"]; // string: Array<any>\r\n\tprivate _objectHooks = [\"character\", \"skill\"]; // string: Object\r\n\tprivate _functionHooks = [\"dynamicTranslate\"]; // string: (player) => string\r\n\r\n\tprivate _hooks: Record<string, Array<Record<string, any>>> = {};\r\n\r\n\tprivate _generateHooks() {\r\n\t\tthis._hooks = {};\r\n\r\n\t\t// ===== 第一组：string: string 钩子 =====\r\n\t\tfor (const name of this._stringHooks) {\r\n\t\t\tthis._hooks[name] = [];\r\n\t\t\tthis[name] = ((...args: any[]) => {\r\n\t\t\t\tthis._registerTypedHook(name, args, \"string\");\r\n\t\t\t}) as any;\r\n\t\t\tthis.pendingRun.push(() => this._runHooks(name));\r\n\t\t}\r\n\r\n\t\t// ===== 第二组：string: Array 钩子 =====\r\n\t\tfor (const name of this._arrayHooks) {\r\n\t\t\tthis._hooks[name] = [];\r\n\t\t\tthis[name] = ((...args: any[]) => {\r\n\t\t\t\tthis._registerTypedHook(name, args, \"array\");\r\n\t\t\t}) as any;\r\n\t\t\tthis.pendingRun.push(() => this._runHooks(name));\r\n\t\t}\r\n\r\n\t\t// ===== 第三组：string: Object 钩子 =====\r\n\t\tfor (const name of this._objectHooks) {\r\n\t\t\tthis._hooks[name] = [];\r\n\t\t\tthis[name] = ((...args: any[]) => {\r\n\t\t\t\tthis._registerTypedHook(name, args, \"object\");\r\n\t\t\t}) as any;\r\n\t\t\tthis.pendingRun.push(() => this._runHooks(name));\r\n\t\t}\r\n\r\n\t\t// ===== 第四组：string: Function 钩子 =====\r\n\t\tfor (const name of this._functionHooks) {\r\n\t\t\tthis._hooks[name] = [];\r\n\t\t\tthis[name] = ((...args: any[]) => {\r\n\t\t\t\tthis._registerTypedHook(name, args, \"function\");\r\n\t\t\t}) as any;\r\n\t\t\tthis.pendingRun.push(() => this._runHooks(name));\r\n\t\t}\r\n\t}\r\n\r\n\t// ========== 统一类型注册入口 ==========\r\n\tprivate _registerTypedHook(\r\n\t\thookName: string,\r\n\t\targs: any[],\r\n\t\tvalueType: \"string\" | \"array\" | \"object\" | \"function\"\r\n\t): void {\r\n\t\t// 批量注册: hook({k: value})\r\n\t\tif (args.length === 1 && typeof args[0] === \"object\" && args[0] !== null && !Array.isArray(args[0])) {\r\n\t\t\tfor (const key in args[0]) {\r\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(args[0], key)) {\r\n\t\t\t\t\tthis._validateAndRegister(hookName, key, args[0][key], valueType);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 单条注册: hook(key: string, value: T)\r\n\t\tif (args.length === 2 && typeof args[0] === \"string\") {\r\n\t\t\tthis._validateAndRegister(hookName, args[0], args[1], valueType);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// 错误提示\r\n\t\tconst typeDesc = {\r\n\t\t\tstring: \"string\",\r\n\t\t\tarray: \"Array\",\r\n\t\t\tobject: \"object\",\r\n\t\t\tfunction: \"Function\"\r\n\t\t}[valueType];\r\n\r\n\t\tconst examples = {\r\n\t\t\tstring: `  ${hookName}(\"key\", \"value\")\\n  ${hookName}({ key1: \"value1\", key2: \"value2\" })`,\r\n\t\t\tarray: `  ${hookName}(\"key\", [\"item1\", \"item2\"])\\n  ${hookName}({ key1: [\"a\"], key2: [\"b\", \"c\"] })`,\r\n\t\t\tobject: `  ${hookName}(\"key\", { prop: value })\\n  ${hookName}({ key1: { ... }, key2: { ... } })`,\r\n\t\t\tfunction: `  ${hookName}(\"key\", (player) => \"text\")\\n  ${hookName}({ key1: (p) => \"a\", key2: (p) => \"b\" })`\r\n\t\t}[valueType];\r\n\r\n\t\tthrow new Error(\r\n\t\t\t`[${hookName}] Invalid invocation. Expected:\\n${examples}`\r\n\t\t);\r\n\t}\r\n\r\n\t// ========== 类型校验与注册 ==========\r\n\tprivate _validateAndRegister(\r\n\t\thookName: string,\r\n\t\tkey: string,\r\n\t\tvalue: any,\r\n\t\tvalueType: \"string\" | \"array\" | \"object\" | \"function\"\r\n\t): void {\r\n\t\t// 类型校验\r\n\t\tswitch (valueType) {\r\n\t\t\tcase \"string\":\r\n\t\t\t\tif (typeof value !== \"string\") {\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t`[${hookName}] Value for key \"${key}\" must be string, got ${typeof value}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"array\":\r\n\t\t\t\tif (!Array.isArray(value)) {\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t`[${hookName}] Value for key \"${key}\" must be Array, got ${typeof value}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"object\":\r\n\t\t\t\tif (typeof value !== \"object\" || value === null || Array.isArray(value)) {\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t`[${hookName}] Value for key \"${key}\" must be plain object, got ${typeof value}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"function\":\r\n\t\t\t\tif (typeof value !== \"function\") {\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t`[${hookName}] Value for key \"${key}\" must be function, got ${typeof value}`\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\r\n\t\t// 注册到钩子队列\r\n\t\tthis._hooks[hookName].push({\r\n\t\t\tkey,\r\n\t\t\tobj: value // 所有值都通过 obj 存储，运行时直接赋值\r\n\t\t});\r\n\t}\r\n\r\n\t// ========== 运行钩子 ==========\r\n\tprivate async _runHooks(hookName: string, args: any[] = []): Promise<void> {\r\n\t\tconst hooks = this._hooks[hookName];\r\n\t\tif (!hooks?.length) return;\r\n\r\n\t\tconst sorted = [...hooks].sort((a, b) => (b.priority ?? 0) - (a.priority ?? 0));\r\n\r\n\t\tfor (const hook of sorted) {\r\n\t\t\tconst { key, obj } = hook;\r\n\r\n\t\t\t// ===== 防重复校验：禁止覆盖已有属性 =====\r\n\t\t\tif (lib[hookName]?.[key] !== undefined) {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t`[WhichWayPackHooks] Duplicate hook key \"${String(key)}\" in \"${hookName}\". ` +\r\n\t\t\t\t\t`lib.${hookName}[\"${String(key)}\"] already exists and cannot be overwritten.`\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tlib[hookName][key] = obj; // 直接赋值（所有钩子统一使用 obj）\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconsole.error(`[WhichWayPackHooks] Error setting hook \"${String(key)}\" (${hookName}):`, err);\r\n\t\t\t\tthrow err;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpendingRun: Function[] = [];\r\n\r\n\t// ====== 类型声明 ======\r\n\tdeclare translate: (\r\n\t\tkey: string | Record<string, string>,\r\n\t\tcontent?: string\r\n\t) => void;\r\n\r\n\tdeclare characterIntro: (\r\n\t\tkey: string | Record<string, string>,\r\n\t\tcontent?: string\r\n\t) => void;\r\n\r\n\tdeclare characterTitle: (\r\n\t\tkey: string | Record<string, string>,\r\n\t\tcontent?: string\r\n\t) => void;\r\n\r\n\tdeclare characterReplace: (\r\n\t\tkey: string | Record<string, string[]>,\r\n\t\tcontent?: string[]\r\n\t) => void;\r\n\r\n\tdeclare character: (\r\n\t\tkey: string | Record<string, WhichWayCharacterPending>,\r\n\t\tcontent?: WhichWayCharacterPending\r\n\t) => void;\r\n\r\n\tdeclare skill: (\r\n\t\tkey: string | Record<string, ExtendedSkill>,\r\n\t\tcontent?: Record<string, ExtendedSkill>\r\n\t) => void;\r\n\r\n\tdeclare dynamicTranslate: (\r\n\t\tkey: string | Record<string, (player: Player) => string>,\r\n\t\tcontent?: (player: Player) => string\r\n\t) => void;\r\n\t// ======================\r\n}\r\n\r\nconst packHooks = new WhichWayPackHooks();\r\n\r\nexport const {\r\n\tskill,\r\n\tcharacter,\r\n\ttranslate,\r\n\tcharacterIntro,\r\n\tcharacterTitle,\r\n\tcharacterReplace,\r\n\tdynamicTranslate,\r\n\tpendingRun,\r\n} = packHooks;\r\n"],"names":[],"mappings":";AAEA,MAAM,kBAAkB;AAAA,EACvB,cAAc;AACb,SAAK,eAAA;AAAA,EACN;AAAA,EAEQ,UAAU;AAAA;AAAA,EAGV,eAAe,CAAC,aAAa,kBAAkB,gBAAgB;AAAA;AAAA,EAC/D,cAAc,CAAC,kBAAkB;AAAA;AAAA,EACjC,eAAe,CAAC,aAAa,OAAO;AAAA;AAAA,EACpC,iBAAiB,CAAC,kBAAkB;AAAA;AAAA,EAEpC,SAAqD,CAAA;AAAA,EAErD,iBAAiB;AACxB,SAAK,SAAS,CAAA;AAGd,eAAW,QAAQ,KAAK,cAAc;AACrC,WAAK,OAAO,IAAI,IAAI,CAAA;AACpB,WAAK,IAAI,KAAK,IAAI,SAAgB;AACjC,aAAK,mBAAmB,MAAM,MAAM,QAAQ;AAAA,MAC7C;AACA,WAAK,WAAW,KAAK,MAAM,KAAK,UAAU,IAAI,CAAC;AAAA,IAChD;AAGA,eAAW,QAAQ,KAAK,aAAa;AACpC,WAAK,OAAO,IAAI,IAAI,CAAA;AACpB,WAAK,IAAI,KAAK,IAAI,SAAgB;AACjC,aAAK,mBAAmB,MAAM,MAAM,OAAO;AAAA,MAC5C;AACA,WAAK,WAAW,KAAK,MAAM,KAAK,UAAU,IAAI,CAAC;AAAA,IAChD;AAGA,eAAW,QAAQ,KAAK,cAAc;AACrC,WAAK,OAAO,IAAI,IAAI,CAAA;AACpB,WAAK,IAAI,KAAK,IAAI,SAAgB;AACjC,aAAK,mBAAmB,MAAM,MAAM,QAAQ;AAAA,MAC7C;AACA,WAAK,WAAW,KAAK,MAAM,KAAK,UAAU,IAAI,CAAC;AAAA,IAChD;AAGA,eAAW,QAAQ,KAAK,gBAAgB;AACvC,WAAK,OAAO,IAAI,IAAI,CAAA;AACpB,WAAK,IAAI,KAAK,IAAI,SAAgB;AACjC,aAAK,mBAAmB,MAAM,MAAM,UAAU;AAAA,MAC/C;AACA,WAAK,WAAW,KAAK,MAAM,KAAK,UAAU,IAAI,CAAC;AAAA,IAChD;AAAA,EACD;AAAA;AAAA,EAGQ,mBACP,UACA,MACA,WACO;AAEP,QAAI,KAAK,WAAW,KAAK,OAAO,KAAK,CAAC,MAAM,YAAY,KAAK,CAAC,MAAM,QAAQ,CAAC,MAAM,QAAQ,KAAK,CAAC,CAAC,GAAG;AACpG,iBAAW,OAAO,KAAK,CAAC,GAAG;AAC1B,YAAI,OAAO,UAAU,eAAe,KAAK,KAAK,CAAC,GAAG,GAAG,GAAG;AACvD,eAAK,qBAAqB,UAAU,KAAK,KAAK,CAAC,EAAE,GAAG,GAAG,SAAS;AAAA,QACjE;AAAA,MACD;AACA;AAAA,IACD;AAGA,QAAI,KAAK,WAAW,KAAK,OAAO,KAAK,CAAC,MAAM,UAAU;AACrD,WAAK,qBAAqB,UAAU,KAAK,CAAC,GAAG,KAAK,CAAC,GAAG,SAAS;AAC/D;AAAA,IACD;AAUA,UAAM,WAAW;AAAA,MAChB,QAAQ,KAAK,QAAQ;AAAA,IAAuB,QAAQ;AAAA,MACpD,OAAO,KAAK,QAAQ;AAAA,IAAkC,QAAQ;AAAA,MAC9D,QAAQ,KAAK,QAAQ;AAAA,IAA+B,QAAQ;AAAA,MAC5D,UAAU,KAAK,QAAQ;AAAA,IAAkC,QAAQ;AAAA,IAAA,EAChE,SAAS;AAEX,UAAM,IAAI;AAAA,MACT,IAAI,QAAQ;AAAA,EAAoC,QAAQ;AAAA,IAAA;AAAA,EAE1D;AAAA;AAAA,EAGQ,qBACP,UACA,KACA,OACA,WACO;AAEP,YAAQ,WAAA;AAAA,MACP,KAAK;AACJ,YAAI,OAAO,UAAU,UAAU;AAC9B,gBAAM,IAAI;AAAA,YACT,IAAI,QAAQ,oBAAoB,GAAG,yBAAyB,OAAO,KAAK;AAAA,UAAA;AAAA,QAE1E;AACA;AAAA,MACD,KAAK;AACJ,YAAI,CAAC,MAAM,QAAQ,KAAK,GAAG;AAC1B,gBAAM,IAAI;AAAA,YACT,IAAI,QAAQ,oBAAoB,GAAG,wBAAwB,OAAO,KAAK;AAAA,UAAA;AAAA,QAEzE;AACA;AAAA,MACD,KAAK;AACJ,YAAI,OAAO,UAAU,YAAY,UAAU,QAAQ,MAAM,QAAQ,KAAK,GAAG;AACxE,gBAAM,IAAI;AAAA,YACT,IAAI,QAAQ,oBAAoB,GAAG,+BAA+B,OAAO,KAAK;AAAA,UAAA;AAAA,QAEhF;AACA;AAAA,MACD,KAAK;AACJ,YAAI,OAAO,UAAU,YAAY;AAChC,gBAAM,IAAI;AAAA,YACT,IAAI,QAAQ,oBAAoB,GAAG,2BAA2B,OAAO,KAAK;AAAA,UAAA;AAAA,QAE5E;AACA;AAAA,IAAA;AAIF,SAAK,OAAO,QAAQ,EAAE,KAAK;AAAA,MAC1B;AAAA,MACA,KAAK;AAAA;AAAA,IAAA,CACL;AAAA,EACF;AAAA;AAAA,EAGA,MAAc,UAAU,UAAkB,OAAc,IAAmB;AAC1E,UAAM,QAAQ,KAAK,OAAO,QAAQ;AAClC,QAAI,CAAC,OAAO,OAAQ;AAEpB,UAAM,SAAS,CAAC,GAAG,KAAK,EAAE,KAAK,CAAC,GAAG,OAAO,EAAE,YAAY,MAAM,EAAE,YAAY,EAAE;AAE9E,eAAW,QAAQ,QAAQ;AAC1B,YAAM,EAAE,KAAK,IAAA,IAAQ;AAGrB,UAAI,IAAI,QAAQ,IAAI,GAAG,MAAM,QAAW;AACvC,cAAM,IAAI;AAAA,UACT,2CAA2C,OAAO,GAAG,CAAC,SAAS,QAAQ,UAChE,QAAQ,KAAK,OAAO,GAAG,CAAC;AAAA,QAAA;AAAA,MAEjC;AAEA,UAAI;AACH,YAAI,QAAQ,EAAE,GAAG,IAAI;AAAA,MACtB,SAAS,KAAK;AACb,gBAAQ,MAAM,2CAA2C,OAAO,GAAG,CAAC,MAAM,QAAQ,MAAM,GAAG;AAC3F,cAAM;AAAA,MACP;AAAA,IACD;AAAA,EACD;AAAA,EAEA,aAAyB,CAAA;AAAA;AAsC1B;AAEA,MAAM,YAAY,IAAI,kBAAA;AAEf,MAAM;AAAA,EACZ;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACD,IAAI;"}