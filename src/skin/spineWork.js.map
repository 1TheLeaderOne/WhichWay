{"version":3,"file":"spineWork.js","sources":["../../../../../../packages/extension/WhichWay/src/skin/spineWork.js"],"sourcesContent":["import { spineWhitherHelm as spine } from \"../../lib/spine-player.js\";\r\nimport { lib, game, ui, get, ai, _status } from \"noname\";\r\nimport { whichWayUtil } from \"../utill.js\";\r\nimport { whichWayToast } from \"../toast/index.ts\";\r\nimport { onSetDev } from \"../hooks/index.js\";\r\nimport { whichWayFile } from \"../file.js\";\r\n\r\nconst dycSave = window.whichWaySave.dycSave;\r\n\r\nclass SpineWorker {\r\n\tbackgroundPath = `${lib.assetURL}extension/WhichWay/dynamicSkin/background/`;\r\n\r\n\tspineCache = new Map();\r\n\r\n\teventListenersMap = new WeakMap();\r\n\r\n\tget banSkin() {\r\n\t\tif(lib.config.banSkinSJZX === void 0) lib.config.banSkinSJZX = {}\r\n\t\treturn lib.config.banSkinSJZX;\r\n\t}\r\n\r\n\t/**\r\n\t * 切换动皮开启与关闭\r\n\t * @param {String | Player} name 玩家名\r\n\t * @param {String} skinName 皮肤名\r\n\t */\r\n\ttoggleDycSkin(name, skinName) {\r\n\t\t//@ts-ignore\r\n\t\tif (get.itemtype(name) === \"player\") name = name.name;\r\n\t\tif (typeof name !== \"string\") throw new Error(\"参数name必须是 String 或 Player！\");\r\n\t\tif (typeof skinName !== \"string\") throw new Error(\"参数skinName必须是 String！\");\r\n\r\n\t\tif (spineWorker.banSkin?.[name]?.[skinName]) spineWorker.banSkin[name][skinName] = false;\r\n\t\telse {\r\n\t\t\tif (!spineWorker.banSkin[name]) spineWorker.banSkin[name] = {};\r\n\t\t\tspineWorker.banSkin[name][skinName] = true;\r\n\t\t}\r\n\r\n\t\tgame.saveConfig(\"banSkinSJZX\", spineWorker.banSkin);\r\n\r\n\t\treturn spineWorker.banSkin;\r\n\t}\r\n\r\n\t/**\r\n\t * 判断指定角色和皮肤的动态皮肤是否启用\r\n\t * @param {String | Player} name 玩家名\r\n\t * @param {String} skinName 皮肤名\r\n\t * @returns {boolean}\r\n\t */\r\n\tisEnabledSkin(name, skinName) {\r\n\t\t//@ts-ignore\r\n\t\tif (get.itemtype(name) === \"player\") name = name.name;\r\n\t\t//@ts-ignore\r\n\t\treturn !this.banSkin?.[name]?.[skinName];\r\n\t}\r\n\r\n\t/**\r\n\t * 获取指定角色和皮肤的动态皮肤数据\r\n\t * @param {string} charName - 角色名称\r\n\t * @param {string} skinName - 皮肤名称\r\n\t * @param {boolean} [noGetAll=false] - 当charName或skinName未定义时，是否返回所有资产数据\r\n\t * @returns {Object|undefined} 找到的皮肤数据对象，未找到时返回undefined\r\n\t */\r\n\tgetSkinData(charName, skinName, noGetAll) {\r\n\t\tlet assets = dycSave.assets;\r\n\t\tif (charName === void 0 || skinName === void 0) return noGetAll ? assets : undefined;\r\n\t\tfor (let name in assets) {\r\n\t\t\tif (charName !== name) continue;\r\n\t\t\tfor (let assetsSkinName in assets[name]) {\r\n\t\t\t\tif (assetsSkinName !== skinName) continue;\r\n\t\t\t\treturn assets[name][assetsSkinName];\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (whichWayUtil.isDeveloperMode()) console.warn(`【驶舰之向】:未找到角色 ${charName} 的皮肤 ${skinName} !`);\r\n\t\treturn undefined;\r\n\t}\r\n\r\n\tgetUrl(name, skinName, file, fileExtension) {\r\n\t\tconst fileExtensionMap = {\r\n\t\t\tj: \"json\",\r\n\t\t\ta: \"atlas\",\r\n\t\t\ts: \"skel\",\r\n\t\t};\r\n\t\tif (fileExtension.length === 1 && fileExtensionMap[fileExtension]) fileExtension = fileExtensionMap[fileExtension];\r\n\t\treturn `${lib.assetURL}extension/WhichWay/dynamicSkin/illust/${name}/${skinName}/${file}.${fileExtension}`;\r\n\t}\r\n\r\n\tdispose(player) {\r\n\t\tif (player.disposed) return;\r\n\t\tplayer.disposed = true;\r\n\r\n\t\t//移除缓存中的记录\r\n\t\tlet cache = this.spineCache;\r\n\t\tlet dycSave = cache.get(player.config.dynamicName);\r\n\t\tif (Object.keys(dycSave).length === 1) cache.delete(player.config.dynamicName);\r\n\t\telse {\r\n\t\t\tfor (let name in dycSave) {\r\n\t\t\t\tlet info = dycSave[name];\r\n\t\t\t\tif (info.from === player.container) {\r\n\t\t\t\t\tdelete dycSave[name];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\twindow.removeEventListener(\"resize\", player.drawFrame);\r\n\r\n\t\tconst container = player.parent;\r\n\r\n\t\tplayer.stopRendering();\r\n\r\n\t\tif (player.cancelId) {\r\n\t\t\tclearTimeout(player.cancelId);\r\n\t\t}\r\n\r\n\t\tif (player.animationState) {\r\n\t\t\tplayer.animationState.clearTracks();\r\n\t\t\tplayer.animationState.clearListeners();\r\n\r\n\t\t\tlet entry = player.animationState.getCurrent(0);\r\n\t\t\tif (entry) {\r\n\t\t\t\tplayer.animationState.disposeNext(entry);\r\n\t\t\t\tplayer.animationState.setEmptyAnimation(0, 0);\r\n\t\t\t}\r\n\r\n\t\t\tplayer.animationState = null;\r\n\t\t}\r\n\r\n\t\tif (player.skeleton) player.skeleton = null;\r\n\r\n\t\tif (player.skeletonData) player.skeletonData = null;\r\n\r\n\t\tif (player.sceneRenderer) {\r\n\t\t\tplayer.sceneRenderer.dispose();\r\n\t\t\tplayer.sceneRenderer = null;\r\n\t\t}\r\n\r\n\t\tif (player.assetManager) player.assetManager.dispose();\r\n\r\n\t\tif (player.context && player.context.gl) {\r\n\t\t\tconst gl = player.context.gl;\r\n\t\t\tgl.getExtension(\"WEBGL_lose_context\")?.loseContext();\r\n\t\t\tplayer.context = null;\r\n\t\t}\r\n\r\n\t\tif (container) container.remove();\r\n\t}\r\n\r\n\tloadDyc(charName, skinName, target, config) {\r\n\t\tlet data = dycSave.assets;\r\n\t\tlet dynamicName = `${charName}_${skinName}`;\r\n\r\n\t\tif (this.banSkin?.[charName]?.[skinName] === true) return;\r\n\r\n\t\tdycSave.startFit = {\r\n\t\t\tdycLoaded: false,\r\n\t\t\tdecadeUIFit: false,\r\n\t\t\tparent: target,\r\n\t\t\tcontainer: undefined,\r\n\t\t};\r\n\t\tlet startFit = new Proxy(dycSave.startFit, {\r\n\t\t\tset(target, key, newValue, receiver) {\r\n\t\t\t\ttarget[key] = newValue;\r\n\t\t\t\tif (target.dycLoaded && target.decadeUIFit) {\r\n\t\t\t\t\tif (whichWayUtil.isDeveloperMode()) console.log(\"【驶舰之向】:已调整动态皮肤：\", target.container);\r\n\t\t\t\t\tfit(target.container, target.parent);\r\n\t\t\t\t\t//@ts-ignore\r\n\t\t\t\t\tdelete dycSave.startFit;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t},\r\n\t\t});\r\n\t\tif (data[charName] && data[charName][skinName]) {\r\n\t\t\tlet options = data[charName][skinName];\r\n\t\t\tlet urlSkel, urlAtlas;\r\n\t\t\tlet bgUrl = this.backgroundPath + options.background.split(\"/\").pop();\r\n\t\t\tconst container = ui.create.div(\".sjzxDycWrapper\", target);\r\n\t\t\tcontainer.id = \"sjzxDycWrapper-animation\";\r\n\t\t\tcontainer.hide();\r\n\r\n\t\t\t//@ts-ignore\r\n\t\t\tdycSave.startFit.container = container;\r\n\r\n\t\t\tconst bg = ui.create.div(\".bg\", container);\r\n\t\t\tbg.style.backgroundImage = `url(${bgUrl})`;\r\n\t\t\tif (options.name) {\r\n\t\t\t\tif (options.json) urlSkel = this.getUrl(charName, skinName, options.name.split(\"/\").pop(), \"j\");\r\n\t\t\t\telse urlSkel = this.getUrl(charName, skinName, options.name.split(\"/\").pop(), \"s\");\r\n\t\t\t\turlAtlas = this.getUrl(charName, skinName, options.name.split(\"/\").pop(), \"a\");\r\n\t\t\t}\r\n\r\n\t\t\tif (!config)\r\n\t\t\t\tconfig = {\r\n\t\t\t\t\tdynamicName: dynamicName,\r\n\t\t\t\t\tskelUrl: urlSkel,\r\n\t\t\t\t\t//@ts-ignore\r\n\t\t\t\t\tjsonUrl: urlSkel.endsWith(\".json\") ? urlSkel : undefined,\r\n\t\t\t\t\tatlasUrl: urlAtlas,\r\n\t\t\t\t\tshowControls: false,\r\n\t\t\t\t\tanimations: Array.isArray(options.action) ? options.action : [options.action],\r\n\t\t\t\t\tweighting: Array.isArray(options.weighting) ? options.weighting : [options.weighting],\r\n\t\t\t\t\talpha: true,\r\n\t\t\t\t\tbackgroundColor: \"#00000000\",\r\n\t\t\t\t\tdebug: {\r\n\t\t\t\t\t\tbones: false,\r\n\t\t\t\t\t\tregions: false,\r\n\t\t\t\t\t\tmeshes: false,\r\n\t\t\t\t\t\tboundingBoxes: false,\r\n\t\t\t\t\t\tpaths: false,\r\n\t\t\t\t\t\tskins: false,\r\n\t\t\t\t\t\tattachments: false,\r\n\t\t\t\t\t\thulls: false,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tshowLoading: false,\r\n\t\t\t\t\tpremultipliedAlpha: options.alpha || false,\r\n\t\t\t\t\tpreserveDrawingBuffer: true,\r\n\t\t\t\t\tviewport: {\r\n\t\t\t\t\t\tx: 0,\r\n\t\t\t\t\t\ty: 0,\r\n\t\t\t\t\t\twidth: target.clientWidth,\r\n\t\t\t\t\t\theight: target.clientHeight,\r\n\t\t\t\t\t\tpadLeft: 0,\r\n\t\t\t\t\t\tpadRight: 0,\r\n\t\t\t\t\t\tpadTop: 0,\r\n\t\t\t\t\t\tpadBottom: 0,\r\n\t\t\t\t\t},\r\n\t\t\t\t\toriginalOptions: options,\r\n\t\t\t\t\tcontainer: target,\r\n\t\t\t\t\terror: function (reason) {\r\n\t\t\t\t\t\tconsole.error(reason);\r\n\t\t\t\t\t},\r\n\t\t\t\t\tsuccess: function (player) {\r\n\t\t\t\t\t\tspineWorker.setSkeletonPosition(player, player.config.originalOptions);\r\n\t\t\t\t\t\tspineWorker.playRandomAnimation(player.skeleton, player.animationState, player.config.weighting);\r\n\t\t\t\t\t\tstartFit.dycLoaded = true;\r\n\t\t\t\t\t\tcontainer.show();\r\n\t\t\t\t\t},\r\n\t\t\t\t};\r\n\r\n\t\t\t//@ts-ignore\r\n\t\t\tconst player = new spine.SpinePlayer(container, config);\r\n\r\n\t\t\tlet cache = spineWorker.spineCache;\r\n\t\t\tif (!cache.get(dynamicName)) cache.set(dynamicName, {});\r\n\t\t\tlet dycSkin = cache.get(dynamicName);\r\n\t\t\tif (get.itemtype(target) === \"player\") {\r\n\t\t\t\tif (!dycSkin[target.playerid]) dycSkin[target.playerid] = {};\r\n\t\t\t\tdycSkin[target.playerid][\"default\"] = player;\r\n\t\t\t\tdycSkin[target.playerid][\"from\"] = target;\r\n\t\t\t\ttarget.dycSJZX = player;\r\n\t\t\t} else {\r\n\t\t\t\tlet className = target.className;\r\n\t\t\t\tif (!dycSkin[className]) dycSkin[className] = {};\r\n\t\t\t\tdycSkin[className][\"default\"] = player;\r\n\t\t\t\tdycSkin[className][\"from\"] = target;\r\n\t\t\t}\r\n\r\n\t\t\tconst added = `removeAdded_${dynamicName}`;\r\n\t\t\tif (target.dataset[added] !== \"true\") {\r\n\t\t\t\ttarget.dataset[added] = \"true\";\r\n\t\t\t\ttarget.onRemoved(() => {\r\n\t\t\t\t\tlet isPlayer = get.itemtype(target) === \"player\";\r\n\t\t\t\t\tlet dycSkins = dycSkin[isPlayer ? target.playerid : target.className];\r\n\t\t\t\t\tfor (let key in dycSkins) {\r\n\t\t\t\t\t\tif (get.is.object(dycSkins[key])) {\r\n\t\t\t\t\t\t\tspineWorker.dispose(dycSkins[key]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdelete dycSkin[isPlayer ? target.playerid : target.className];\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (get.itemtype(target) === \"player\") {\r\n\t\t\t\ttarget.node.avatar.appendChild(container);\r\n\t\t\t\ttarget.node.avatar.style.overflow = \"hidden\";\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tstartFit.decadeUIFit = true;\r\n\t\t\t\t}, 1000);\r\n\t\t\t}\r\n\t\t\treturn player;\r\n\t\t} else console.error(`no skin data ${charName} ${skinName}`);\r\n\r\n\t\tfunction fit(target, player, time = 4) {\r\n\t\t\tconst transferNum = str => parseFloat(str.match(/-?\\d*\\.?\\d+/)?.[0] || \"0\");\r\n\t\t\tconst oldTransition = target.style.transition;\r\n\t\t\ttarget.style.transition = \"none\";\r\n\r\n\t\t\tlet style = getComputedStyle(target);\r\n\t\t\tlet width = transferNum(style.width);\r\n\t\t\tlet height = transferNum(style.height);\r\n\t\t\tlet left = transferNum(style.left);\r\n\r\n\t\t\tlet playerStyle = getComputedStyle(player);\r\n\t\t\tlet playerWidth = transferNum(playerStyle.width);\r\n\t\t\tlet playerHeight = transferNum(playerStyle.height);\r\n\r\n\t\t\tif (width > 360) {\r\n\t\t\t\ttarget.style.transition = oldTransition;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t[width, height] = whichWayUtil.adjustToRatio(width, height, \"2:3\", [playerWidth, playerHeight]);\r\n\r\n\t\t\ttarget.style.width = `${width * time}px`;\r\n\t\t\ttarget.style.height = `${height * time}px`;\r\n\t\t\ttarget.style.zoom = `${1 / time}`;\r\n\t\t\tif (typeof left === \"number\") target.style.left = `${left * time}px`;\r\n\t\t\t// target.style.left = `-50%`;\r\n\t\t\tvoid target.offsetWidth;\r\n\t\t\ttarget.style.transition = oldTransition;\r\n\r\n\t\t\tdycSave.dycZoom = `${1 / time}`;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 播放完当前动画后，随机播放另一个动画\r\n\t * @param {*} skeleton - Spine 骨骼实例\r\n\t * @param {*} animationState - AnimationState 实例\r\n\t * @param {number[]} weighting - 权重\r\n\t * @param {boolean} [loop=false] - 是否循环播放\r\n\t */\r\n\tplayRandomAnimation(skeleton, animationState, weighting, loop = false) {\r\n\t\tanimationState.addListener({\r\n\t\t\tcomplete: () => {\r\n\t\t\t\tplay(skeleton, animationState, weighting, loop);\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tplay(skeleton, animationState, weighting, loop);\r\n\r\n\t\t/**\r\n\t\t * 随机播放一个动画\r\n\t\t * @param {*} skeleton\r\n\t\t * @param {*} animationState\r\n\t\t * @param {number[]} weighting - 权重\r\n\t\t * @param {boolean} [loop=false]\r\n\t\t */\r\n\t\tfunction play(skeleton, animationState, weighting, loop = false) {\r\n\t\t\tconst animations = skeleton.data.animations.map(anim => anim.name);\r\n\r\n\t\t\tif (!weighting || weighting.length !== animations.length) {\r\n\t\t\t\tweighting = animations.map(() => 1);\r\n\t\t\t}\r\n\r\n\t\t\t//加权随机\r\n\t\t\tlet ratio = whichWayUtil.scaleToIntegerRatio(weighting);\r\n\t\t\tlet population = [];\r\n\t\t\tfor (let i = 0; i < animations.length; i++) {\r\n\t\t\t\tlet animWeight = ratio[i];\r\n\t\t\t\tlet animation = animations[i];\r\n\t\t\t\tpopulation.push(...new Array(animWeight).fill(animation));\r\n\t\t\t}\r\n\r\n\t\t\tconst selectedAnim = population.randomGet();\r\n\r\n\t\t\tif (animations.length === 1) {\r\n\t\t\t\tanimationState.setAnimation(0, selectedAnim, true);\r\n\t\t\t} else {\r\n\t\t\t\tanimationState.setAnimation(0, selectedAnim, loop);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tsetSkeletonPosition(player, options, noFix) {\r\n\t\tconst parent = player.dom.parentNode;\r\n\t\t//@ts-ignore\r\n\t\tconst offset = new spine.Vector2();\r\n\t\t//@ts-ignore\r\n\t\tconst size = new spine.Vector2();\r\n\t\tplayer.skeleton.getBounds(offset, size, []);\r\n\r\n\t\tlet index = [parent.clientWidth / 120, parent.clientHeight / 180];\r\n\r\n\t\tif (noFix) index = [1, 1];\r\n\r\n\t\tplayer.skeleton.scaleX = options.scale * index[0];\r\n\t\tplayer.skeleton.scaleY = options.scale * index[1];\r\n\t\tplayer.skeleton.x = parent.clientWidth * options.x[1] + options.x[0];\r\n\t\tplayer.skeleton.y = parent.clientHeight * options.y[1] + options.y[0];\r\n\t}\r\n\r\n\tplayAction(player, action, duration = 3000) {\r\n\t\tlet char = player.parent.parentNode;\r\n\t\tlet dynamicName = player.config.dynamicName;\r\n\t\tlet playerid = char.playerid;\r\n\t\tlet cache = spineWorker.spineCache;\r\n\r\n\t\tif (cache.get(dynamicName)?.[dynamicName]?.[playerid]?.[action]?.timer) {\r\n\t\t\tclearTimeout(cache.get(dynamicName)[playerid][action].timer);\r\n\t\t}\r\n\r\n\t\tconst actions = [\"chuchang\", \"gongji\", \"teshu\", \"default\"];\r\n\t\tif (!actions.includes(action)) console.warn(`${action}不是合法的动作！`);\r\n\t\tlet actionConfig = player.config.originalOptions[action];\r\n\t\tif (!actionConfig) {\r\n\t\t\tconsole.warn(`${action}没有对应的动作配置！`);\r\n\t\t\twhichWayToast.showToast(`${action}没有对应的动作配置！`);\r\n\t\t}\r\n\r\n\t\tplayer.dom.style.display = \"none\";\r\n\t\tlet data = player.config;\r\n\t\t/** @type { HTMLElement } */\r\n\t\tlet wrapper = player.dom.parentNode;\r\n\t\t//@ts-ignore\r\n\t\twrapper.style.zIndex = 100;\r\n\t\tif (!cache.get(dynamicName)) cache.set(dynamicName, {});\r\n\t\tconst dycSkin = cache.get(dynamicName);\r\n\t\tif (!dycSkin[playerid]) dycSkin[playerid] = {};\r\n\t\tif (!dycSkin[playerid][action]) {\r\n\t\t\tlet container = ui.create.div(\".sjzxDycOutWrapper\", wrapper);\r\n\t\t\tcontainer.classList.add(`${action}`);\r\n\t\t\tconst rect = container.getBoundingClientRect();\r\n\t\t\tcontainer.style.display = \"none\";\r\n\t\t\t//@ts-ignore\r\n\t\t\tdycSkin[playerid][action] = new spine.SpinePlayer(container, {\r\n\t\t\t\tskelUrl: data.skelUrl,\r\n\t\t\t\tjsonUrl: data.jsonUrl,\r\n\t\t\t\tatlasUrl: data.atlasUrl,\r\n\t\t\t\tshowControls: false,\r\n\t\t\t\tanimations: Array.isArray(actionConfig.action) ? actionConfig.action : [actionConfig.action],\r\n\t\t\t\talpha: true,\r\n\t\t\t\tbackgroundColor: \"#00000000\",\r\n\t\t\t\tdebug: {\r\n\t\t\t\t\tbones: false,\r\n\t\t\t\t\tregions: false,\r\n\t\t\t\t\tmeshes: false,\r\n\t\t\t\t\tboundingBoxes: false,\r\n\t\t\t\t\tpaths: false,\r\n\t\t\t\t\tskins: false,\r\n\t\t\t\t\tattachments: false,\r\n\t\t\t\t\thulls: false,\r\n\t\t\t\t},\r\n\t\t\t\tshowLoading: false,\r\n\t\t\t\tpremultipliedAlpha: actionConfig.alpha || false,\r\n\t\t\t\tpreserveDrawingBuffer: true,\r\n\t\t\t\tviewport: {\r\n\t\t\t\t\tx: 0,\r\n\t\t\t\t\ty: 0,\r\n\t\t\t\t\twidth: rect.width,\r\n\t\t\t\t\theight: rect.height,\r\n\t\t\t\t\tpadLeft: 0,\r\n\t\t\t\t\tpadRight: 0,\r\n\t\t\t\t\tpadTop: 0,\r\n\t\t\t\t\tpadBottom: 0,\r\n\t\t\t\t},\r\n\t\t\t\toriginalOptions: actionConfig,\r\n\t\t\t\terror: function (reason) {\r\n\t\t\t\t\tconsole.error(\"spine animation load error\", reason);\r\n\t\t\t\t},\r\n\t\t\t\tsuccess: function (player) {\r\n\t\t\t\t\tconst transferNum = str => parseFloat(str.match(/-?\\d*\\.?\\d+/)?.[0] || \"0\");\r\n\r\n\t\t\t\t\tlet char = player.parent.parentNode.parentNode;\r\n\t\t\t\t\tlet options = player.config.originalOptions;\r\n\t\t\t\t\tlet docStyle = getComputedStyle(document.body);\r\n\t\t\t\t\tlet style = getComputedStyle(char);\r\n\r\n\t\t\t\t\tplayer.skeleton.x = transferNum(docStyle.width) - transferNum(style.right) - transferNum(style.width) / 2;\r\n\t\t\t\t\tplayer.skeleton.y = transferNum(style.bottom);\r\n\r\n\t\t\t\t\tplayer.skeleton.scaleX = options.scale;\r\n\t\t\t\t\tplayer.skeleton.scaleY = options.scale;\r\n\r\n\t\t\t\t\tplayer.speed = actionConfig.speed || 1;\r\n\r\n\t\t\t\t\tplayer.dom.parentNode.style.display = \"\";\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tdycSkin[playerid][action].parent.style.display = \"\";\r\n\t\t}\r\n\r\n\t\tif (duration) {\r\n\t\t\tdycSkin[playerid][action][\"timer\"] = setTimeout(() => {\r\n\t\t\t\tlet container = dycSkin[playerid][action].parent;\r\n\t\t\t\tplayer.dom.style.display = \"\";\r\n\t\t\t\tcontainer.style.display = \"none\";\r\n\t\t\t\twrapper.style.zIndex = \"\";\r\n\t\t\t}, duration);\r\n\t\t}\r\n\t}\r\n\r\n\tasync updateDyc(name, target, action = \"default\") {\r\n\t\tif (!spineWorker.needEnable()) return;\r\n\r\n\t\tlet skin = window.whichWaySave.skinConfig[name] || \"经典形象.1145141919810\";\r\n\t\tlet skinName = whichWayFile.removeExt(skin);\r\n\t\tlet dynamicName = `${name}_${skinName}`;\r\n\r\n\t\tlet cache = spineWorker.spineCache;\r\n\r\n\t\t//停止target中所有其他动皮的播放\r\n\t\tcache.forEach(obj => {\r\n\t\t\tfor (let key in obj) {\r\n\t\t\t\tlet info = obj[key];\r\n\t\t\t\tif (info.from !== target) continue;\r\n\t\t\t\tfor (let action in info) {\r\n\t\t\t\t\tlet player = info[action];\r\n\t\t\t\t\tif (player instanceof HTMLElement) continue;\r\n\t\t\t\t\tplayer.parent.style.display = \"none\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (this.banSkin?.[name]?.[skinName] === true) return;\r\n\r\n\t\tif (cache.has(dynamicName)) {\r\n\t\t\tif (get.itemtype(target) === \"player\" && cache.get(dynamicName)?.[target.playerid]?.[action]) {\r\n\t\t\t\tcache.get(dynamicName)[target.playerid][action].parent.style.display = \"\";\r\n\t\t\t\treturn;\r\n\t\t\t} else if (cache.get(dynamicName)?.[target.className]?.[action]) {\r\n\t\t\t\tcache.get(dynamicName)[target.className][action].parent.style.display = \"\";\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (skin) {\r\n\t\t\tif (spineWorker.getSkinData(name, skinName)) {\r\n\t\t\t\tspineWorker.loadDyc(name, skinName, target);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdraggingDyc(player) {\r\n\t\tif (!spineWorker.needEnable()) return;\r\n\r\n\t\tif (!whichWayUtil.config(\"enableWhichWayDynamicSkin\")) {\r\n\t\t\twhichWayToast.showToast(\"请先开启动态皮肤功能\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (typeof player !== \"object\") {\r\n\t\t\twhichWayToast.showToast(\"不是合法的Spine对象\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\twhichWayToast.showToast(\"已开启动皮拖拽\");\r\n\r\n\t\t//文本复制\r\n\t\tconst copyBtn = document.createElement(\"button\");\r\n\t\tcopyBtn.id = \"copySketeonPostionBtnSJZX\";\r\n\t\tcopyBtn.textContent = \"复制信息\";\r\n\r\n\t\tdocument.body.appendChild(copyBtn);\r\n\r\n\t\tcopyBtn.addEventListener(\"click\", () => {\r\n\t\t\tlet context = [];\r\n\t\t\tlet skeleton = dycSave?.skeletonPostion;\r\n\t\t\tif (skeleton?.x) context.push(`x:[0,${skeleton.x.toFixed(2)}],`);\r\n\t\t\tif (skeleton?.y) context.push(`y:[0,${skeleton.y.toFixed(2)}],`);\r\n\t\t\tif (skeleton?.scale) context.push(`scale:${skeleton.scale.toFixed(2)},`);\r\n\t\t\tif (context.length > 0) {\r\n\t\t\t\tnavigator.clipboard\r\n\t\t\t\t\t.writeText(context.join(\"\\n\"))\r\n\t\t\t\t\t.then(() => {\r\n\t\t\t\t\t\twhichWayToast.showToast(\"复制成功\", 1500, \"bottomRight\", \"skeletonPositionCopySJZX\");\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.catch(err => {\r\n\t\t\t\t\t\tconsole.error(\"复制失败: \", err);\r\n\t\t\t\t\t});\r\n\t\t\t} else whichWayToast.showToast(\"没有可复制的信息!\", 1500);\r\n\t\t});\r\n\r\n\t\t//关闭拖拽\r\n\t\tconst btn = document.createElement(\"button\");\r\n\t\tbtn.id = \"toggleDragBtnSJZX\";\r\n\t\tbtn.textContent = \"关闭拖拽\";\r\n\r\n\t\tdocument.body.appendChild(btn);\r\n\r\n\t\t// 按钮点击事件\r\n\t\tbtn.addEventListener(\"click\", () => {\r\n\t\t\tbtn.remove();\r\n\t\t\tcopyBtn.remove();\r\n\t\t\tspineWorker.stopDraggingDyc(player);\r\n\t\t});\r\n\r\n\t\t/** @type {HTMLElement} **/\r\n\t\tconst parent = player.parent;\r\n\t\tparent.style.pointerEvents = \"all\";\r\n\r\n\t\tconst skeleton = player.skeleton;\r\n\t\tconst domElement = player.dom;\r\n\r\n\t\tlet isDragging = false;\r\n\t\tlet lastX = 0,\r\n\t\t\tlastY = 0;\r\n\r\n\t\tconst minScale = 0.001;\r\n\t\tconst maxScale = 10;\r\n\t\tconst scaleStep = 0.01;\r\n\r\n\t\tlet lastLogTime = 0;\r\n\t\tconst logInterval = 200;\r\n\r\n\t\tconst onMouseDown = e => {\r\n\t\t\tisDragging = true;\r\n\t\t\tlastX = e.clientX;\r\n\t\t\tlastY = e.clientY;\r\n\t\t};\r\n\r\n\t\tconst onMouseMove = e => {\r\n\t\t\tif (!isDragging) return;\r\n\r\n\t\t\tconst dx = e.clientX - lastX;\r\n\t\t\tconst dy = e.clientY - lastY;\r\n\r\n\t\t\tskeleton.x += dx;\r\n\t\t\tskeleton.y += dy;\r\n\r\n\t\t\tlastX = e.clientX;\r\n\t\t\tlastY = e.clientY;\r\n\r\n\t\t\tconst now = Date.now();\r\n\r\n\t\t\tconst viewportWidth = parent.clientWidth;\r\n\t\t\tconst viewportHeight = parent.clientHeight;\r\n\t\t\tconsole.log(viewportWidth, viewportHeight);\r\n\r\n\t\t\tconst percentX = skeleton.x / viewportWidth;\r\n\t\t\tconst percentY = skeleton.y / viewportHeight;\r\n\r\n\t\t\tif (now - lastLogTime > logInterval) {\r\n\t\t\t\tconst str = `骨骼位置: x=${skeleton.x.toFixed(2)} (${percentX.toFixed(2)}), y=${skeleton.y.toFixed(2)} (${percentY.toFixed(2)})`;\r\n\t\t\t\twhichWayToast.showToast(str, true, \"topLeft\", \"dragging_xAndy\");\r\n\t\t\t\tlastLogTime = now;\r\n\r\n\t\t\t\tlet zoom = dycSave.dycZoom || 1;\r\n\t\t\t\tif (!dycSave.skeletonPostion) dycSave.skeletonPostion = {};\r\n\t\t\t\tdycSave.skeletonPostion.x = percentX / zoom;\r\n\t\t\t\tdycSave.skeletonPostion.y = percentY / zoom;\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst onMouseUp = () => {\r\n\t\t\tisDragging = false;\r\n\t\t};\r\n\r\n\t\tconst onWheel = e => {\r\n\t\t\te.preventDefault();\r\n\r\n\t\t\tconst delta = e.deltaY;\r\n\t\t\tlet newScale = skeleton.scaleX;\r\n\r\n\t\t\tif (delta < 0) {\r\n\t\t\t\tnewScale += scaleStep;\r\n\t\t\t} else {\r\n\t\t\t\tnewScale -= scaleStep;\r\n\t\t\t}\r\n\r\n\t\t\tnewScale = Math.max(minScale, Math.min(maxScale, newScale));\r\n\r\n\t\t\tskeleton.scaleX = skeleton.scaleY = newScale;\r\n\r\n\t\t\twhichWayToast.showToast(`当前骨骼缩放: scale=${newScale.toFixed(2)}`, true, \"topLeft\", \"dragging_scale\");\r\n\r\n\t\t\tif (!dycSave.skeletonPostion) dycSave.skeletonPostion = {};\r\n\t\t\tdycSave.skeletonPostion.scale = newScale;\r\n\t\t};\r\n\r\n\t\tspineWorker.eventListenersMap.set(domElement, { onMouseDown, onMouseMove, onMouseUp, onWheel });\r\n\r\n\t\tdomElement.addEventListener(\"mousedown\", onMouseDown);\r\n\t\tdocument.addEventListener(\"mousemove\", onMouseMove);\r\n\t\tdocument.addEventListener(\"mouseup\", onMouseUp);\r\n\t\tdomElement.addEventListener(\"wheel\", onWheel, { passive: false }); // 注意：passive: false 才能调用 preventDefault\r\n\t}\r\n\r\n\tstopDraggingDyc(player) {\r\n\t\tlet parent = player.parent;\r\n\t\tparent.style.pointerEvents = \"none\";\r\n\r\n\t\tconst domElement = player.dom;\r\n\r\n\t\tconst listeners = spineWorker.eventListenersMap.get(domElement);\r\n\t\tif (listeners) {\r\n\t\t\tconst { onMouseDown, onMouseMove, onMouseUp, onWheel } = listeners;\r\n\r\n\t\t\tdomElement.removeEventListener(\"mousedown\", onMouseDown);\r\n\t\t\tdocument.removeEventListener(\"mousemove\", onMouseMove);\r\n\t\t\tdocument.removeEventListener(\"mouseup\", onMouseUp);\r\n\t\t\tdomElement.removeEventListener(\"wheel\", onWheel);\r\n\t\t}\r\n\r\n\t\tspineWorker.eventListenersMap.delete(domElement);\r\n\r\n\t\tlet toasts = whichWayToast.toastRegistry;\r\n\t\tfor (let key in toasts) {\r\n\t\t\tlet info = toasts[key];\r\n\t\t\tif (typeof info === \"function\") continue;\r\n\t\t\tfor (let obj of info) {\r\n\t\t\t\tlet id = obj.id;\r\n\t\t\t\tif (id.startsWith(\"dragging_\")) {\r\n\t\t\t\t\twhichWayToast.removeToastById(id);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 判断是否需要启用驶舰之向的动皮\r\n\t * @returns {Boolean}\r\n\t */\r\n\tneedEnable() {\r\n\t\tlet mode = whichWayUtil.config(\"WhichWayDynamicSkinSwitch\") || \"sjzx\";\r\n\t\tswitch (mode) {\r\n\t\t\tcase \"sjzx\":\r\n\t\t\t\treturn whichWayUtil.config(\"enableWhichWayDynamicSkin\") || whichWayUtil.config(\"enableWhichWayDynamicSkin\") === undefined;\r\n\t\t\tcase \"piqie\": {\r\n\t\t\t\tlet lack = [];\r\n\t\t\t\tif (!lib.extensionPack[\"皮肤切换\"]) lack.push(\"皮肤切换\");\r\n\t\t\t\tif (!lib.extensionPack[\"千幻聆音\"]) lack.push(\"千幻聆音\");\r\n\t\t\t\tif (!lib.extensionPack[\"十周年UI\"]) lack.push(\"十周年UI\");\r\n\t\t\t\treturn lack.length === 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nexport const spineWorker = new SpineWorker();\r\n\r\nonSetDev({\r\n\tname: \"whichWaySpineWorker_dev\",\r\n\tfn(){\r\n\t\t//@ts-ignore\r\n\t\twindow.spineWorker = spineWorker;\r\n\t}\r\n})\r\n\r\nwindow.whichWay.register(\"spineWorker\", spineWorker);"],"names":["dycSave","target","player","spine","skeleton","animationState","weighting","loop","char","action"],"mappings":"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"}