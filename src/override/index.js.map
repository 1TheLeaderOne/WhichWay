{"version":3,"file":"index.js","sources":["../../../../../../packages/extension/WhichWay/src/override/index.js"],"sourcesContent":["import { onSetDev } from \"../hooks/index.js\";\r\nimport { lib, game, ui, get, ai, _status } from \"noname\";\r\n\r\nclass WhichWayAPIOverride {\r\n\tconstructor() {\r\n\t\t/**\r\n\t\t * @type {Map<string, {\r\n\t\t *   original: Function|any,\r\n\t\t *   current: Function|any,\r\n\t\t *   type: 'override' | 'hook',\r\n\t\t *   hook?: { before?: Function, after?: Function },\r\n\t\t *   path: string,\r\n\t\t *   overriddenAt: string\r\n\t\t * }>}\r\n\t\t */\r\n\t\tthis.overrides = new Map();\r\n\t}\r\n\r\n\t/**\r\n\t * 允许修改的API列表\r\n\t * @type {Record<string, any>}\r\n\t */\r\n\tapis = {\r\n\t\tlib:lib,\r\n\t\tgame:game,\r\n\t\tui:ui,\r\n\t\tget:get,\r\n\t\tai:ai,\r\n\t\t_status:_status,\r\n\t}\r\n\r\n\t/**\r\n\t * 是否是合法的API\r\n\t * @param {string} name\r\n\t * \r\n\t * @returns {boolean} \r\n\t */\r\n\tisVaildAPI(name){\r\n\t\treturn Object.keys(this.apis).includes(name);\r\n\t}\r\n\r\n\t/**\r\n\t * 完全替换指定 API\r\n\t * @param {string} apiName - 如 \"game.check\"\r\n\t * @param {any} apiNew - 新实现\r\n\t */\r\n\toverrideAPI(apiName, apiNew) {\r\n\t\tthis._validateAndSet(apiName, \"override\", apiNew);\r\n\t}\r\n\r\n\t/**\r\n\t * 在原 API 执行前后追加逻辑（不替换原函数）\r\n\t * @param {string} apiName - API 路径\r\n\t * @param {{ before?: Function, after?: Function }} options\r\n\t *   - before(...args): 可返回新参数数组，或返回 false 阻止执行\r\n\t *   - after(result, ...originalArgs): 可返回新结果\r\n\t */\r\n\tasync appendHook(apiName, { before, after }) {\r\n\t\tif (!before && !after) {\r\n\t\t\tthrow new Error('At least one of \"before\" or \"after\" must be provided');\r\n\t\t}\r\n\r\n\t\tconst parts = apiName.split(\".\");\r\n\t\tconst prop = parts.pop();\r\n\t\tlet obj = this.apis;\r\n\r\n\t\tif(!this.isVaildAPI(parts[0])){\r\n\t\t\tthrow new Error(`Invalid API name: ${parts[0]} , must be one of ${Object.keys(this.apis)}`);\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tfor (const part of parts) {\r\n\t\t\t\tif (obj == null || typeof obj !== \"object\") {\r\n\t\t\t\t\tthrow new Error(`Invalid path: ${apiName}`);\r\n\t\t\t\t}\r\n\t\t\t\tobj = obj[part];\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tthrow new Error(`Cannot access property ${apiName}, current Object is ${obj}`);\r\n\t\t}\r\n\r\n\t\tif (obj == null || typeof obj !== \"object\") {\r\n\t\t\tthrow new Error(`Parent of '${prop}' is not an object in path: ${apiName}`);\r\n\t\t}\r\n\r\n\t\t//@ts-ignore\r\n\t\tconst original = obj[prop];\r\n\r\n\t\tif (typeof original !== \"function\") {\r\n\t\t\tthrow new Error(`Target API '${apiName}' is not a function — hooks only work on functions`);\r\n\t\t}\r\n\r\n\t\t// 创建包装函数\r\n\t\tconst wrapped = async function (...args) {\r\n\t\t\t// === 执行 before 钩子 ===\r\n\t\t\tif (before) {\r\n\t\t\t\t//@ts-ignore\r\n\t\t\t\tconst beforeResult = await before.apply(this, args);\r\n\t\t\t\tif (beforeResult === false) {\r\n\t\t\t\t\t// 阻止执行原函数\r\n\t\t\t\t\treturn undefined;\r\n\t\t\t\t}\r\n\t\t\t\tif (Array.isArray(beforeResult)) {\r\n\t\t\t\t\t// 允许修改参数\r\n\t\t\t\t\targs = beforeResult;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//@ts-ignore\r\n\t\t\tconst result = await original.apply(this, args);\r\n\r\n\t\t\t// === 执行 after 钩子 ===\r\n\t\t\tif (after) {\r\n\t\t\t\t//@ts-ignore\r\n\t\t\t\tconst afterResult = await after.call(this, result, ...args);\r\n\t\t\t\treturn afterResult !== undefined ? afterResult : result;\r\n\t\t\t}\r\n\r\n\t\t\treturn result;\r\n\t\t};\r\n\r\n\t\tconst record = {\r\n\t\t\toriginal,\r\n\t\t\tcurrent: wrapped,\r\n\t\t\ttype: \"hook\",\r\n\t\t\thook: { before, after },\r\n\t\t\tpath: apiName,\r\n\t\t\toverriddenAt: new Date().toISOString(),\r\n\t\t};\r\n\r\n\t\ttry {\r\n\t\t\t//@ts-ignore\r\n\t\t\tobj[prop] = wrapped;\r\n\t\t\t//@ts-ignore\r\n\t\t\tthis.overrides.set(apiName, record);\r\n\t\t\tconsole.debug(`[WhichWayAPIOverride] Hook added to: ${apiName}`);\r\n\t\t} catch (e) {\r\n\t\t\t//@ts-ignore\r\n\t\t\tthrow new Error(`Failed to hook '${apiName}': ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 内部通用设置逻辑（用于 override 和 hook）\r\n\t */\r\n\t_validateAndSet(apiName, type, newValue) {\r\n\t\tif (typeof apiName !== \"string\" || !apiName.trim()) {\r\n\t\t\tthrow new Error(\"apiName must be a non-empty string\");\r\n\t\t}\r\n\r\n\t\tconst parts = apiName.split(\".\");\r\n\t\tconst prop = parts.pop();\r\n\t\tlet obj = this.apis;\r\n\r\n\t\tif(!this.isVaildAPI(parts[0])){\r\n\t\t\tthrow new Error(`Invalid API name: ${parts[0]} , must be one of ${Object.keys(this.apis)}`);\r\n\t\t}\r\n\r\n\t\tif (prop === void 0) throw new Error(\"apiName must be a non-empty string\");\r\n\r\n\t\ttry {\r\n\t\t\tfor (const part of parts) {\r\n\t\t\t\tif (obj == null || typeof obj !== \"object\") {\r\n\t\t\t\t\tthrow new Error(`Cannot access property '${part}' in path '${apiName}'`);\r\n\t\t\t\t}\r\n\t\t\t\tobj = obj[part];\r\n\t\t\t}\r\n\r\n\t\t\tif (obj == null || typeof obj !== \"object\") {\r\n\t\t\t\tthrow new Error(`Parent object of '${prop}' is invalid in path: ${apiName}`);\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tthrow new Error(`Cannot access property ${apiName}, current Object is ${obj}`);\r\n\t\t}\r\n\r\n\t\tconst original = obj[prop];\r\n\t\tconst record = {\r\n\t\t\toriginal,\r\n\t\t\tcurrent: newValue,\r\n\t\t\ttype,\r\n\t\t\tpath: apiName,\r\n\t\t\toverriddenAt: new Date().toISOString(),\r\n\t\t};\r\n\r\n\t\ttry {\r\n\t\t\tobj[prop] = newValue;\r\n\t\t\tthis.overrides.set(apiName, record);\r\n\t\t\tconsole.debug(`[WhichWayAPIOverride] ${type === \"override\" ? \"Overrode\" : \"Hooked\"}: ${apiName}`);\r\n\t\t} catch (e) {\r\n\t\t\t//@ts-ignore\r\n\t\t\tthrow new Error(`Failed to set '${apiName}': ${e.message}`);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 恢复指定 API 到原始状态\r\n\t */\r\n\trestoreAPI(apiName) {\r\n\t\tconst record = this.overrides.get(apiName);\r\n\t\tif (!record) {\r\n\t\t\tconsole.warn(`[WhichWayAPIOverride] No override/hook found for: ${apiName}`);\r\n\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\tconst parts = apiName.split(\".\");\r\n\t\tconst prop = parts.pop();\r\n\t\tlet obj = globalThis;\r\n\t\tfor (const part of parts) obj = obj[part];\r\n\r\n\t\ttry {\r\n\t\t\tobj[prop] = record.original;\r\n\t\t\tthis.overrides.delete(apiName);\r\n\t\t\tconsole.debug(`[WhichWayAPIOverride] Restored: ${apiName}`);\r\n\t\t\treturn true;\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(`[WhichWayAPIOverride] Failed to restore ${apiName}:`, e);\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 获取所有被覆盖/挂钩的 API 列表\r\n\t */\r\n\tgetOverrideList() {\r\n\t\treturn Array.from(this.overrides.entries()).map(([path, info]) => ({\r\n\t\t\tpath,\r\n\t\t\ttype: info.type,\r\n\t\t\toverriddenAt: info.overriddenAt,\r\n\t\t}));\r\n\t}\r\n\r\n\t/**\r\n\t * 打印调试信息\r\n\t */\r\n\tdebug() {\r\n\t\tif (this.overrides.size === 0) {\r\n\t\t\tconsole.log(\"[WhichWayAPIOverride] No APIs have been overridden or hooked.\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconsole.group(`[WhichWayAPIOverride] ${this.overrides.size} modified API(s):`);\r\n\t\tfor (const [path, info] of this.overrides) {\r\n\t\t\tconsole.log(`- ${path} (${info.type}) at ${info.overriddenAt}`);\r\n\t\t\tif (info.type === \"hook\") {\r\n\t\t\t\tconsole.log(`  Before:`, info.hook?.before);\r\n\t\t\t\tconsole.log(`  After:`, info.hook?.after);\r\n\t\t\t}\r\n\t\t}\r\n\t\tconsole.groupEnd();\r\n\t}\r\n}\r\n\r\nexport const whichWayAPIOverride = new WhichWayAPIOverride();\r\n\r\nonSetDev({\r\n\tname: \"whichWayAPIOverride_dev\",\r\n\tfn: () => {\r\n\t\t//@ts-ignore\r\n\t\twindow.whichWayAPIOverride = whichWayAPIOverride;\r\n\t},\r\n});\r\n\r\nwindow.whichWay.register(\"override\", whichWayAPIOverride);\r\n"],"names":[],"mappings":"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"}