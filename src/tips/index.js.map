{"version":3,"file":"index.js","sources":["../../../../../../packages/extension/WhichWay/src/tips/index.ts"],"sourcesContent":["import { onArenaReady, onSetDev } from \"../hooks/index.js\";\r\nimport { lib, game, ui, get, ai, _status } from \"noname\";\r\n\r\ntype autoDelPrompt = Record<string, Record<delTrigger, Array<string>>>;\r\ntype delTrigger = \"addGroup\" | \"addNature\" | \"checkBegin\" | \"checkCard\" | \"checkTarget\" | \"checkButton\" | \"checkEnd\" | \"uncheckBegin\" | \"uncheckCard\" | \"uncheckTarget\" | \"uncheckButton\" | \"uncheckEnd\" | \"checkOverflow\" | \"checkTipBottom\" | \"checkDamage1\" | \"checkDamage2\" | \"checkDamage3\" | \"checkDamage4\" | \"checkDie\" | \"checkUpdate\" | \"checkSkillAnimate\" | \"addSkillCheck\" | \"removeSkillCheck\" | \"refreshSkin\";\r\n\r\nclass WhichWayTips {\r\n\tregisterHook(name: delTrigger, fn?: (...args: any) => any) {\r\n\t\tif (!fn) fn = this._hookTriggerDefaultFunc;\r\n\t\tif (this.triggerHooks[name]) {\r\n\t\t\tconsole.warn(`[WhichWayTips] hook ${name} already registered`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.triggerHooks[name] = fn;\r\n\t\tif (lib.hooks[name]) lib.hooks[name].push((...args) => fn(name, ...args));\r\n\t\telse throw new Error(`[WhichWayTips] hook ${name} not found`);\r\n\t}\r\n\r\n\tprivate _hookTriggerDefaultFunc(triggerName: delTrigger, ...args: [GameEvent, Card, Player]) {\r\n\t\tconst [event] = args;\r\n\t\tif (!event) return;\r\n\t\tconst { player, name } = event;\r\n\t\tif (player) {\r\n\t\t\t//自动删除player的prompt\r\n\t\t\tconst id = whichWayTips.getID(player);\r\n\t\t\tif (whichWayTips.autoDelPrompt[id]) {\r\n\t\t\t\tif (whichWayTips.autoDelPrompt[id][triggerName]) whichWayTips.autoDelPrompt[id][triggerName].forEach(i => whichWayTips.removePrompt(player, i));\r\n\t\t\t}\r\n\r\n\t\t\t//自动删除card的prompt\r\n\t\t\tfor (const card of player.getCards(\"h\")) {\r\n\t\t\t\tconst id = whichWayTips.getID(card);\r\n\t\t\t\tif (!whichWayTips.autoDelPrompt[id]) continue;\r\n\t\t\t\tif (whichWayTips.autoDelPrompt[id][triggerName]) whichWayTips.autoDelPrompt[id][triggerName].forEach(i => whichWayTips.removePrompt(card, i));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetID(el: Card | Player): string {\r\n\t\t//@ts-ignore\r\n\t\treturn get.itemtype(el) === \"player\" ? el.playerid : el.cardid;\r\n\t}\r\n\r\n\tregisterDel(el: Card | Player, del: delTrigger, id: string) {\r\n\t\tconst elID = this.getID(el);\r\n\t\t//@ts-ignore\r\n\t\tthis.autoDelPrompt[elID] ??= {};\r\n\t\tthis.autoDelPrompt[elID][del] ??= [];\r\n\t\tthis.autoDelPrompt[elID][del].push(id);\r\n\r\n\t\tif (!this.triggerHooks[del]) this.registerHook(del);\r\n\t}\r\n\r\n\taddPrompt(el: Card | Player, str: string, id?: string, del?: delTrigger): Card | Player {\r\n\t\tconst isPlayer = get.itemtype(el) === \"player\";\r\n\t\tconst prompts = this[isPlayer ? \"promptsPlayer\" : \"promptsCard\"];\r\n\t\tconst elID = this.getID(el);\r\n\t\tprompts[elID] ??= {};\r\n\r\n\t\tlet wrapper = el.querySelector(\".promptSJZX-Wrapper\") || ui.create.div(\".promptSJZX-Wrapper\", el);\r\n\r\n\t\tif (id && prompts[elID]?.[id]) {\r\n\t\t\tprompts[elID][id].innerHTML = str;\r\n\t\t\tif (del) this.registerDel(el, del, id);\r\n\t\t\treturn el;\r\n\t\t}\r\n\r\n\t\tlet info = ui.create.div(\".promptSJZX\", wrapper);\r\n\t\tinfo.classList.add(isPlayer ? \"promptCharacterSJZX\" : \"promptCardSJZX\");\r\n\t\tinfo.innerHTML = str;\r\n\t\tprompts[elID][id || str] = info;\r\n\t\tif (del) this.registerDel(el, del, id || str);\r\n\t\treturn el;\r\n\t}\r\n\r\n\tremovePrompt(el: Card | Player, id?: string): Card | Player {\r\n\t\tconst isPlayer = get.itemtype(el) === \"player\";\r\n\t\tconst prompts = this[isPlayer ? \"promptsPlayer\" : \"promptsCard\"];\r\n\t\tconst elID = this.getID(el);\r\n\t\tprompts[elID] ??= {};\r\n\r\n\t\tlet targets = el.querySelectorAll(\".promptSJZX\");\r\n\t\tif (!targets) return el;\r\n\t\telse if (typeof id !== \"string\")\r\n\t\t\ttargets.forEach(i => {\r\n\t\t\t\tfor (let key in prompts) {\r\n\t\t\t\t\tif (prompts[elID][key] === i) {\r\n\t\t\t\t\t\tdelete prompts[elID][key];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\ti.remove();\r\n\t\t\t});\r\n\t\telse {\r\n\t\t\tif (prompts[elID][id]) {\r\n\t\t\t\tprompts[elID][id].remove();\r\n\t\t\t\tdelete prompts[elID][id];\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!Object.keys(prompts[elID]).length) delete prompts[elID];\r\n\t\treturn el;\r\n\t}\r\n\r\n\tpromptsCard: Record<string, Record<string, HTMLElement>> = {};\r\n\r\n\tpromptsPlayer: Record<string, Record<string, HTMLElement>> = {};\r\n\r\n\tautoDelPrompt: autoDelPrompt = {};\r\n\r\n\t//@ts-ignore\r\n\ttriggerHooks: Record<delTrigger, Function> = {};\r\n}\r\n\r\nexport const whichWayTips = new WhichWayTips();\r\n\r\nonSetDev({\r\n\tname: \"WhichWayTips_dev\",\r\n\tfn() {\r\n\t\t//@ts-ignore\r\n\t\twindow.whichWayTips = whichWayTips;\r\n\t},\r\n});\r\n\r\nwindow.whichWay.register(\"tips\", whichWayTips);\r\n"],"names":["id"],"mappings":"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"}