{"version":3,"file":"Animation.js","sources":["../../../../../../packages/extension/WhichWay/lib/Sortable/Animation.js"],"sourcesContent":["import { getRect, css, matrix, isRectEqual, indexOfObject } from './utils.js';\nimport Sortable from './Sortable.js';\n\nexport default function AnimationStateManager() {\n\tlet animationStates = [],\n\t\tanimationCallbackId;\n\n\treturn {\n\t\tcaptureAnimationState() {\n\t\t\tanimationStates = [];\n\t\t\tif (!this.options.animation) return;\n\t\t\tlet children = [].slice.call(this.el.children);\n\n\t\t\tchildren.forEach(child => {\n\t\t\t\tif (css(child, 'display') === 'none' || child === Sortable.ghost) return;\n\t\t\t\tanimationStates.push({\n\t\t\t\t\ttarget: child,\n\t\t\t\t\trect: getRect(child)\n\t\t\t\t});\n\t\t\t\tlet fromRect = { ...animationStates[animationStates.length - 1].rect };\n\n\t\t\t\t// If animating: compensate for current animation\n\t\t\t\tif (child.thisAnimationDuration) {\n\t\t\t\t\tlet childMatrix = matrix(child, true);\n\t\t\t\t\tif (childMatrix) {\n\t\t\t\t\t\tfromRect.top -= childMatrix.f;\n\t\t\t\t\t\tfromRect.left -= childMatrix.e;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tchild.fromRect = fromRect;\n\t\t\t});\n\t\t},\n\n\t\taddAnimationState(state) {\n\t\t\tanimationStates.push(state);\n\t\t},\n\n\t\tremoveAnimationState(target) {\n\t\t\tanimationStates.splice(indexOfObject(animationStates, { target }), 1);\n\t\t},\n\n\t\tanimateAll(callback) {\n\t\t\tif (!this.options.animation) {\n\t\t\t\tclearTimeout(animationCallbackId);\n\t\t\t\tif (typeof(callback) === 'function') callback();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet animating = false,\n\t\t\t\tanimationTime = 0;\n\n\t\t\tanimationStates.forEach((state) => {\n\t\t\t\tlet time = 0,\n\t\t\t\t\tanimatingThis = false,\n\t\t\t\t\ttarget = state.target,\n\t\t\t\t\tfromRect = target.fromRect,\n\t\t\t\t\ttoRect = getRect(target),\n\t\t\t\t\tprevFromRect = target.prevFromRect,\n\t\t\t\t\tprevToRect = target.prevToRect,\n\t\t\t\t\tanimatingRect = state.rect,\n\t\t\t\t\ttargetMatrix = matrix(target, true);\n\n\n\t\t\t\tif (targetMatrix) {\n\t\t\t\t\t// Compensate for current animation\n\t\t\t\t\ttoRect.top -= targetMatrix.f;\n\t\t\t\t\ttoRect.left -= targetMatrix.e;\n\t\t\t\t}\n\n\t\t\t\ttarget.toRect = toRect;\n\n\t\t\t\tif (target.thisAnimationDuration) {\n\t\t\t\t\t// Could also check if animatingRect is between fromRect and toRect\n\t\t\t\t\tif (\n\t\t\t\t\t\tisRectEqual(prevFromRect, toRect) &&\n\t\t\t\t\t\t!isRectEqual(fromRect, toRect) &&\n\t\t\t\t\t\t// Make sure animatingRect is on line between toRect & fromRect\n\t\t\t\t\t\t(animatingRect.top - toRect.top) /\n\t\t\t\t\t\t(animatingRect.left - toRect.left) ===\n\t\t\t\t\t\t(fromRect.top - toRect.top) /\n\t\t\t\t\t\t(fromRect.left - toRect.left)\n\t\t\t\t\t) {\n\t\t\t\t\t\t// If returning to same place as started from animation and on same axis\n\t\t\t\t\t\ttime = calculateRealTime(animatingRect, prevFromRect, prevToRect, this.options);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// if fromRect != toRect: animate\n\t\t\t\tif (!isRectEqual(toRect, fromRect)) {\n\t\t\t\t\ttarget.prevFromRect = fromRect;\n\t\t\t\t\ttarget.prevToRect = toRect;\n\n\t\t\t\t\tif (!time) {\n\t\t\t\t\t\ttime = this.options.animation;\n\t\t\t\t\t}\n\t\t\t\t\tthis.animate(\n\t\t\t\t\t\ttarget,\n\t\t\t\t\t\tanimatingRect,\n\t\t\t\t\t\ttoRect,\n\t\t\t\t\t\ttime\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (time) {\n\t\t\t\t\tanimating = true;\n\t\t\t\t\tanimationTime = Math.max(animationTime, time);\n\t\t\t\t\tclearTimeout(target.animationResetTimer);\n\t\t\t\t\ttarget.animationResetTimer = setTimeout(function() {\n\t\t\t\t\t\ttarget.animationTime = 0;\n\t\t\t\t\t\ttarget.prevFromRect = null;\n\t\t\t\t\t\ttarget.fromRect = null;\n\t\t\t\t\t\ttarget.prevToRect = null;\n\t\t\t\t\t\ttarget.thisAnimationDuration = null;\n\t\t\t\t\t}, time);\n\t\t\t\t\ttarget.thisAnimationDuration = time;\n\t\t\t\t}\n\t\t\t});\n\n\n\t\t\tclearTimeout(animationCallbackId);\n\t\t\tif (!animating) {\n\t\t\t\tif (typeof(callback) === 'function') callback();\n\t\t\t} else {\n\t\t\t\tanimationCallbackId = setTimeout(function() {\n\t\t\t\t\tif (typeof(callback) === 'function') callback();\n\t\t\t\t}, animationTime);\n\t\t\t}\n\t\t\tanimationStates = [];\n\t\t},\n\n\t\tanimate(target, currentRect, toRect, duration) {\n\t\t\tif (duration) {\n\t\t\t\tcss(target, 'transition', '');\n\t\t\t\tcss(target, 'transform', '');\n\t\t\t\tlet elMatrix = matrix(this.el),\n\t\t\t\t\tscaleX = elMatrix && elMatrix.a,\n\t\t\t\t\tscaleY = elMatrix && elMatrix.d,\n\t\t\t\t\ttranslateX = (currentRect.left - toRect.left) / (scaleX || 1),\n\t\t\t\t\ttranslateY = (currentRect.top - toRect.top) / (scaleY || 1);\n\n\t\t\t\ttarget.animatingX = !!translateX;\n\t\t\t\ttarget.animatingY = !!translateY;\n\n\t\t\t\tcss(target, 'transform', 'translate3d(' + translateX + 'px,' + translateY + 'px,0)');\n\n\t\t\t\tthis.forRepaintDummy = repaint(target); // repaint\n\n\t\t\t\tcss(target, 'transition', 'transform ' + duration + 'ms' + (this.options.easing ? ' ' + this.options.easing : ''));\n\t\t\t\tcss(target, 'transform', 'translate3d(0,0,0)');\n\t\t\t\t(typeof target.animated === 'number') && clearTimeout(target.animated);\n\t\t\t\ttarget.animated = setTimeout(function () {\n\t\t\t\t\tcss(target, 'transition', '');\n\t\t\t\t\tcss(target, 'transform', '');\n\t\t\t\t\ttarget.animated = false;\n\n\t\t\t\t\ttarget.animatingX = false;\n\t\t\t\t\ttarget.animatingY = false;\n\t\t\t\t}, duration);\n\t\t\t}\n\t\t}\n\t};\n}\n\nfunction repaint(target) {\n\treturn target.offsetWidth;\n}\n\n\nfunction calculateRealTime(animatingRect, fromRect, toRect, options) {\n\treturn (\n\t\tMath.sqrt(Math.pow(fromRect.top - animatingRect.top, 2) + Math.pow(fromRect.left - animatingRect.left, 2)) /\n\t\tMath.sqrt(Math.pow(fromRect.top - toRect.top, 2) + Math.pow(fromRect.left - toRect.left, 2))\n\t) * options.animation;\n}\n"],"names":[],"mappings":"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"}