{"version":3,"file":"Animation.js","sources":["../../../../../../packages/extension/WhichWay/lib/Sortable/Animation.js"],"sourcesContent":["import { getRect, css, matrix, isRectEqual, indexOfObject } from './utils.js';\r\nimport Sortable from './Sortable.js';\r\n\r\nexport default function AnimationStateManager() {\r\n\tlet animationStates = [],\r\n\t\tanimationCallbackId;\r\n\r\n\treturn {\r\n\t\tcaptureAnimationState() {\r\n\t\t\tanimationStates = [];\r\n\t\t\tif (!this.options.animation) return;\r\n\t\t\tlet children = [].slice.call(this.el.children);\r\n\r\n\t\t\tchildren.forEach(child => {\r\n\t\t\t\tif (css(child, 'display') === 'none' || child === Sortable.ghost) return;\r\n\t\t\t\tanimationStates.push({\r\n\t\t\t\t\ttarget: child,\r\n\t\t\t\t\trect: getRect(child)\r\n\t\t\t\t});\r\n\t\t\t\tlet fromRect = { ...animationStates[animationStates.length - 1].rect };\r\n\r\n\t\t\t\t// If animating: compensate for current animation\r\n\t\t\t\tif (child.thisAnimationDuration) {\r\n\t\t\t\t\tlet childMatrix = matrix(child, true);\r\n\t\t\t\t\tif (childMatrix) {\r\n\t\t\t\t\t\tfromRect.top -= childMatrix.f;\r\n\t\t\t\t\t\tfromRect.left -= childMatrix.e;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tchild.fromRect = fromRect;\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\taddAnimationState(state) {\r\n\t\t\tanimationStates.push(state);\r\n\t\t},\r\n\r\n\t\tremoveAnimationState(target) {\r\n\t\t\tanimationStates.splice(indexOfObject(animationStates, { target }), 1);\r\n\t\t},\r\n\r\n\t\tanimateAll(callback) {\r\n\t\t\tif (!this.options.animation) {\r\n\t\t\t\tclearTimeout(animationCallbackId);\r\n\t\t\t\tif (typeof(callback) === 'function') callback();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tlet animating = false,\r\n\t\t\t\tanimationTime = 0;\r\n\r\n\t\t\tanimationStates.forEach((state) => {\r\n\t\t\t\tlet time = 0,\r\n\t\t\t\t\tanimatingThis = false,\r\n\t\t\t\t\ttarget = state.target,\r\n\t\t\t\t\tfromRect = target.fromRect,\r\n\t\t\t\t\ttoRect = getRect(target),\r\n\t\t\t\t\tprevFromRect = target.prevFromRect,\r\n\t\t\t\t\tprevToRect = target.prevToRect,\r\n\t\t\t\t\tanimatingRect = state.rect,\r\n\t\t\t\t\ttargetMatrix = matrix(target, true);\r\n\r\n\r\n\t\t\t\tif (targetMatrix) {\r\n\t\t\t\t\t// Compensate for current animation\r\n\t\t\t\t\ttoRect.top -= targetMatrix.f;\r\n\t\t\t\t\ttoRect.left -= targetMatrix.e;\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttarget.toRect = toRect;\r\n\r\n\t\t\t\tif (target.thisAnimationDuration) {\r\n\t\t\t\t\t// Could also check if animatingRect is between fromRect and toRect\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tisRectEqual(prevFromRect, toRect) &&\r\n\t\t\t\t\t\t!isRectEqual(fromRect, toRect) &&\r\n\t\t\t\t\t\t// Make sure animatingRect is on line between toRect & fromRect\r\n\t\t\t\t\t\t(animatingRect.top - toRect.top) /\r\n\t\t\t\t\t\t(animatingRect.left - toRect.left) ===\r\n\t\t\t\t\t\t(fromRect.top - toRect.top) /\r\n\t\t\t\t\t\t(fromRect.left - toRect.left)\r\n\t\t\t\t\t) {\r\n\t\t\t\t\t\t// If returning to same place as started from animation and on same axis\r\n\t\t\t\t\t\ttime = calculateRealTime(animatingRect, prevFromRect, prevToRect, this.options);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// if fromRect != toRect: animate\r\n\t\t\t\tif (!isRectEqual(toRect, fromRect)) {\r\n\t\t\t\t\ttarget.prevFromRect = fromRect;\r\n\t\t\t\t\ttarget.prevToRect = toRect;\r\n\r\n\t\t\t\t\tif (!time) {\r\n\t\t\t\t\t\ttime = this.options.animation;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.animate(\r\n\t\t\t\t\t\ttarget,\r\n\t\t\t\t\t\tanimatingRect,\r\n\t\t\t\t\t\ttoRect,\r\n\t\t\t\t\t\ttime\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (time) {\r\n\t\t\t\t\tanimating = true;\r\n\t\t\t\t\tanimationTime = Math.max(animationTime, time);\r\n\t\t\t\t\tclearTimeout(target.animationResetTimer);\r\n\t\t\t\t\ttarget.animationResetTimer = setTimeout(function() {\r\n\t\t\t\t\t\ttarget.animationTime = 0;\r\n\t\t\t\t\t\ttarget.prevFromRect = null;\r\n\t\t\t\t\t\ttarget.fromRect = null;\r\n\t\t\t\t\t\ttarget.prevToRect = null;\r\n\t\t\t\t\t\ttarget.thisAnimationDuration = null;\r\n\t\t\t\t\t}, time);\r\n\t\t\t\t\ttarget.thisAnimationDuration = time;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\r\n\t\t\tclearTimeout(animationCallbackId);\r\n\t\t\tif (!animating) {\r\n\t\t\t\tif (typeof(callback) === 'function') callback();\r\n\t\t\t} else {\r\n\t\t\t\tanimationCallbackId = setTimeout(function() {\r\n\t\t\t\t\tif (typeof(callback) === 'function') callback();\r\n\t\t\t\t}, animationTime);\r\n\t\t\t}\r\n\t\t\tanimationStates = [];\r\n\t\t},\r\n\r\n\t\tanimate(target, currentRect, toRect, duration) {\r\n\t\t\tif (duration) {\r\n\t\t\t\tcss(target, 'transition', '');\r\n\t\t\t\tcss(target, 'transform', '');\r\n\t\t\t\tlet elMatrix = matrix(this.el),\r\n\t\t\t\t\tscaleX = elMatrix && elMatrix.a,\r\n\t\t\t\t\tscaleY = elMatrix && elMatrix.d,\r\n\t\t\t\t\ttranslateX = (currentRect.left - toRect.left) / (scaleX || 1),\r\n\t\t\t\t\ttranslateY = (currentRect.top - toRect.top) / (scaleY || 1);\r\n\r\n\t\t\t\ttarget.animatingX = !!translateX;\r\n\t\t\t\ttarget.animatingY = !!translateY;\r\n\r\n\t\t\t\tcss(target, 'transform', 'translate3d(' + translateX + 'px,' + translateY + 'px,0)');\r\n\r\n\t\t\t\tthis.forRepaintDummy = repaint(target); // repaint\r\n\r\n\t\t\t\tcss(target, 'transition', 'transform ' + duration + 'ms' + (this.options.easing ? ' ' + this.options.easing : ''));\r\n\t\t\t\tcss(target, 'transform', 'translate3d(0,0,0)');\r\n\t\t\t\t(typeof target.animated === 'number') && clearTimeout(target.animated);\r\n\t\t\t\ttarget.animated = setTimeout(function () {\r\n\t\t\t\t\tcss(target, 'transition', '');\r\n\t\t\t\t\tcss(target, 'transform', '');\r\n\t\t\t\t\ttarget.animated = false;\r\n\r\n\t\t\t\t\ttarget.animatingX = false;\r\n\t\t\t\t\ttarget.animatingY = false;\r\n\t\t\t\t}, duration);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n}\r\n\r\nfunction repaint(target) {\r\n\treturn target.offsetWidth;\r\n}\r\n\r\n\r\nfunction calculateRealTime(animatingRect, fromRect, toRect, options) {\r\n\treturn (\r\n\t\tMath.sqrt(Math.pow(fromRect.top - animatingRect.top, 2) + Math.pow(fromRect.left - animatingRect.left, 2)) /\r\n\t\tMath.sqrt(Math.pow(fromRect.top - toRect.top, 2) + Math.pow(fromRect.left - toRect.left, 2))\r\n\t) * options.animation;\r\n}\r\n"],"names":[],"mappings":"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"}